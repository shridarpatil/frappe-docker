# version: '3.8'

services:
    # buid-app:
    #   image: shridh0r/frappe:develop
    #   build:
    #     context: .
    #     dockerfile: ./Dockerfile

    web-app:
        image: shridh0r/frappe:develop
        deploy:
          replicas: 1
        ports:
          - "8000:8000"
        restart: unless-stopped
        volumes:
          - ./sites:/home/frappe/frappe-bench/sites
          - ./sites/Procfile:/home/frappe/frappe-bench/Procfile
          - ./run.sh:/home/frappe/frappe-bench/run.sh
          # App volumes are auto-generated in docker-compose.override.yml
          # Run 'make up' instead of 'docker-compose up'
        depends_on:
          redis:
            condition: service_started
          mariadb:
            condition: service_started
            required: false
          postgres:
            condition: service_started
            required: false
        env_file:
         - env_file

        # command: sh -c "cd /home/frappe/frappe-bench && bench use site1.local && /home/frappe/.local/bin/bench start"
        # command: sh -c "cd /home/frappe/frappe-bench/sites && /home/frappe/frappe-bench/env/bin/gunicorn -b 0.0.0.0:8000 --workers 8 --threads 4 -t 120 frappe.app:application --preload"
        command: sh run.sh

    default-worker:
        image: shridh0r/frappe:develop
        profiles: ["workers", "prod"]
        restart: unless-stopped
        volumes:
          - ./sites:/home/frappe/frappe-bench/sites
          - ./run.sh:/home/frappe/frappe-bench/run.sh
        command: sh -c "cd /home/frappe/frappe-bench && . ./run.sh && bench setup requirements && install && bench worker --queue default"
        depends_on:
          redis:
            condition: service_started
          mariadb:
            condition: service_started
            required: false
          postgres:
            condition: service_started
            required: false

    long-worker:
        image: shridh0r/frappe:develop
        profiles: ["workers", "prod"]
        restart: unless-stopped
        volumes:
          - ./sites:/home/frappe/frappe-bench/sites
          - ./run.sh:/home/frappe/frappe-bench/run.sh
        command: sh -c "cd /home/frappe/frappe-bench && . ./run.sh && bench setup requirements && install && bench worker --queue long"
        depends_on:
          redis:
            condition: service_started
          mariadb:
            condition: service_started
            required: false
          postgres:
            condition: service_started
            required: false

    short-worker:
        image: shridh0r/frappe:develop
        profiles: ["workers", "prod"]
        restart: unless-stopped
        volumes:
          - ./sites:/home/frappe/frappe-bench/sites
          - ./run.sh:/home/frappe/frappe-bench/run.sh
        command: sh -c "cd /home/frappe/frappe-bench && . ./run.sh && bench setup requirements && install && bench worker --queue short"
        depends_on:
          redis:
            condition: service_started
          mariadb:
            condition: service_started
            required: false
          postgres:
            condition: service_started
            required: false

    scheduler:
        image: shridh0r/frappe:develop
        profiles: ["workers", "prod"]
        restart: unless-stopped
        volumes:
          - ./sites:/home/frappe/frappe-bench/sites
          - ./run.sh:/home/frappe/frappe-bench/run.sh
        command: sh -c "cd /home/frappe/frappe-bench && . ./run.sh && bench setup requirements && install && bench schedule"
        depends_on:
          redis:
            condition: service_started
          mariadb:
            condition: service_started
            required: false
          postgres:
            condition: service_started
            required: false

    socketio:
        image: shridh0r/frappe:develop
        profiles: ["socketio", "prod"]
        restart: unless-stopped
        ports:
            - "9000:9000"
        extra_hosts:
          - "localhost:host-gateway"
        volumes:
          - ./sites:/home/frappe/frappe-bench/sites
          - ./run.sh:/home/frappe/frappe-bench/run.sh
        command: sh -c "cd /home/frappe/frappe-bench && . ./run.sh && install && node apps/frappe/socketio.js"
        depends_on:
          - redis

    redis:
        image: "redis:7"
        ports:
          - 6379
        volumes:
          - ./data/redis:/data

    mariadb:
        image: "${DB_IMAGE:-mariadb:12}"
        profiles: ["mariadb"]
        ports:
          - 3306
        environment:
          - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-root}
        volumes:
          - ./data/mysql:/var/lib/mysql
          - ./new.cnf:/etc/mysql/my.cnf
        networks:
          default:
            aliases:
              - db

    postgres:
        image: "postgres:14.10"
        profiles: ["postgres"]
        ports:
          - 5432
        environment:
          - POSTGRES_PASSWORD=${DB_ROOT_PASSWORD:-root}
        volumes:
          - ./data/postgres:/var/lib/postgresql/data
        networks:
          default:
            aliases:
              - db

    nginx:
        image: nginx
        ports:
          - "80:80"
        volumes:
            - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
            - ./sites:/home/frappe/frappe-bench/sites
        volumes_from:
          - web-app:ro
        depends_on:
          - web-app

