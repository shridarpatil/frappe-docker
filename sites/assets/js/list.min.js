!function(){"use strict";frappe.templates.listing='<div class="frappe-list">  <div class="list-filters" style="display: none;">  </div>   <div style="margin-bottom:9px" class="list-toolbar-wrapper hide">   <div class="list-toolbar btn-group" style="display:inline-block; margin-right: 10px;">   </div>  </div>     <div style="clear:both"></div>  <div class="no-result text-center" style="display: none;">   {%= no_result_message %}  </div>  <div class="result">   <div class="list-headers"></div>         <div class="list-loading text-center">          {%= frappe.messages.get_waiting_message(__("Loading") + "..." ) %}         </div>   <div class="result-list"></div>  </div>  <div class="list-paging-area">   <div class="row">    <div class="col-xs-6">     <div class="btn-group btn-group-paging">      <button type="button" class="btn btn-default btn-sm btn-info" data-value="20">20</button>      <button type="button" class="btn btn-default btn-sm" data-value="100">100</button>      <button type="button" class="btn btn-default btn-sm" data-value="500">500</button>     </div>    </div>    <div class="col-xs-6 text-right">     <button class="btn btn-default btn-more btn-sm">{%= _more %}...</button>    </div>   </div>  </div> </div> ',frappe.has_indicator=function(t){return!!frappe.model.is_submittable(t)||(!(!(frappe.listview_settings[t]||{}).get_indicator&&!frappe.workflow.get_state_fieldname(t))||!(!frappe.meta.has_field(t,"enabled")&&!frappe.meta.has_field(t,"disabled")))},frappe.get_indicator=function(t,e){if(t.__unsaved)return[__("Not Saved"),"orange"];e||(e=t.doctype);var i=frappe.workflow.workflows[e],s=!i||i.override_status,a=frappe.listview_settings[e]||{},n=frappe.model.is_submittable(e),r=frappe.workflow.get_state_fieldname(e);if(r&&!s){var l=t[r];if(l){var o="";if(locals["Workflow State"][l]&&locals["Workflow State"][l].style)o={Success:"green",Warning:"orange",Danger:"red",Primary:"blue"}[locals["Workflow State"][l].style];return o||(o="darkgrey"),[__(l),o,r+",=,"+l]}}if(n&&0==t.docstatus&&!a.has_indicator_for_draft)return[__("Draft"),"red","docstatus,=,0"];if(n&&2==t.docstatus)return[__("Cancelled"),"red","docstatus,=,2"];if(a.get_indicator){var d=a.get_indicator(t);if(d)return d}return n&&1==t.docstatus?[__("Submitted"),"blue","docstatus,=,1"]:t.status?[__(t.status),frappe.utils.guess_colour(t.status)]:frappe.meta.has_field(e,"enabled")?t.enabled?[__("Enabled"),"blue","enabled,=,1"]:[__("Disabled"),"grey","enabled,=,0"]:frappe.meta.has_field(e,"disabled")?t.disabled?[__("Disabled"),"grey","disabled,=,1"]:[__("Enabled"),"blue","disabled,=,0"]:void 0},frappe.ui.Filter=class{constructor(t){var e;$.extend(this,t),null!==this.value&&void 0!==this.value||(this.value=""),this.utils=frappe.ui.filter_utils,this.conditions=[["=",__("Equals")],["!=",__("Not Equals")],["like",__("Like")],["not like",__("Not Like")],["in",__("In")],["not in",__("Not In")],["is",__("Is")],[">",">"],["<","<"],[">=",">="],["<=","<="],["Between",__("Between")],["Previous",__("Previous")],["Next",__("Next")]],this.nested_set_conditions=[["descendants of",__("Descendants Of")],["not descendants of",__("Not Descendants Of")],["ancestors of",__("Ancestors Of")],["not ancestors of",__("Not Ancestors Of")]],(e=this.conditions).push.apply(e,this.nested_set_conditions),this.invalid_condition_map={Date:["like","not like"],Datetime:["like","not like"],Data:["Between","Previous","Next"],Select:["like","not like","Between","Previous","Next"],Link:["Between","Previous","Next",">","<",">=","<="],Currency:["Between","Previous","Next"],Color:["Between","Previous","Next"],Check:this.conditions.map(function(t){return t[0]}).filter(function(t){return"="!==t})},this.make(),this.make_select(),this.set_events(),this.setup()}make(){this.filter_edit_area=$(frappe.render_template("edit_filter",{conditions:this.conditions})).appendTo(this.parent.find(".filter-edit-area"))}make_select(){var t=this;this.fieldselect=new frappe.ui.FieldSelect({parent:this.filter_edit_area.find(".fieldname-select-area"),doctype:this.parent_doctype,filter_fields:this.filter_fields,select:function(e,i){t.set_field(e,i)}}),this.fieldname&&this.fieldselect.set_value(this.doctype,this.fieldname)}set_events(){var t=this;this.filter_edit_area.find("a.remove-filter").on("click",function(){t.remove()}),this.filter_edit_area.find(".set-filter-and-run").on("click",function(){t.filter_edit_area.removeClass("new-filter"),t.on_change(),t.update_filter_tag()}),this.filter_edit_area.find(".condition").change(function(){if(t.field){var e=t.get_condition(),i=null;["in","like","not in","not like"].includes(e)&&(i="Data",t.add_condition_help(e)),["Select","MultiSelect"].includes(t.field.df.fieldtype)&&["in","not in"].includes(e)&&(i="MultiSelect"),t.set_field(t.field.df.parent,t.field.df.fieldname,i,e)}})}setup(){var t=this.fieldname||"name";return this.set_values(this.doctype,t,this.condition,this.value)}setup_state(t){var e=this,i=Promise.resolve();t?this.filter_edit_area.addClass("new-filter"):i=this.update_filter_tag(),this.hidden&&i.then(function(){return e.$filter_tag.hide()})}freeze(){this.update_filter_tag()}update_filter_tag(){var t=this;return this._filter_value_set?this._filter_value_set.then(function(){t.$filter_tag?t.set_filter_button_text():t.make_tag(),t.filter_edit_area.hide()}):Promise.resolve()}remove(){this.filter_edit_area.remove(),this.$filter_tag&&this.$filter_tag.remove(),this.field=null,this.on_change(!0)}set_values(t,e,i,s){if(!1!==this.set_field(t,e))return"Check"===this.field.df.original_type&&(s=1==s?"Yes":"No"),i&&this.set_condition(i,!0),this._filter_value_set=Promise.resolve(),["in","not in"].includes(i)&&Array.isArray(s)&&(s=s.join(",")),Array.isArray(s)?this._filter_value_set=this.field.set_value(s):void 0===s&&null===s||(this._filter_value_set=this.field.set_value((s+"").trim())),this._filter_value_set}set_field(t,e,i,s){var a={};if(this.field)for(var n in this.field.df)a[n]=this.field.df[n];var r=(this.fieldselect.fields_by_name[t]||{})[e];if(!r)return console.warn("Field "+e+" is not selectable."),this.remove(),!1;var l=copy_dict(r);l.read_only=0,l.hidden=0,l.is_filter=!0;var o=s||this.utils.get_default_condition(l);this.set_condition(o),this.utils.set_fieldtype(l,i,this.get_condition()),this.field&&a.fieldname==e&&l.fieldtype==a.fieldtype&&l.parent==a.parent||(this.fieldselect.selected_doctype=t,this.fieldselect.selected_fieldname=e,["Previous","Next"].includes(s)&&["Date","Datetime","DateRange","Select"].includes(this.field.df.fieldtype)&&(l.fieldtype="Select",l.options=[{label:__("1 week"),value:"1 week"},{label:__("1 month"),value:"1 month"},{label:__("3 months"),value:"3 months"},{label:__("6 months"),value:"6 months"},{label:__("1 year"),value:"1 year"}]),this.make_field(l,a.fieldtype))}make_field(t,e){var i=this,s=this.field?this.field.get_value():null;this.hide_invalid_conditions(t.fieldtype,t.original_type),this.toggle_nested_set_conditions(t);var a=this.filter_edit_area.find(".filter-field").empty().get(0),n=frappe.ui.form.make_control({df:t,parent:a,only_input:!0});n.refresh(),this.field=n,s&&n.fieldtype===e&&this.field.set_value(s),$(this.field.wrapper).find(":input").keydown(function(t){13==t.which&&"MultiSelect"!==i.field.df.fieldtype&&i.on_change()})}get_value(){return[this.fieldselect.selected_doctype,this.field.df.fieldname,this.get_condition(),this.get_selected_value(),this.hidden]}get_selected_value(){return this.utils.get_selected_value(this.field,this.get_condition())}get_condition(){return this.filter_edit_area.find(".condition").val()}set_condition(t,e){void 0===e&&(e=!1);var i=this.filter_edit_area.find(".condition");i.val(t),e&&i.change()}make_tag(){this.$filter_tag=this.get_filter_tag_element().insertAfter(this.parent.find(".active-tag-filters .add-filter")),this.set_filter_button_text(),this.bind_tag()}bind_tag(){var t=this;this.$filter_tag.find(".remove-filter").on("click",this.remove.bind(this));var e=this.$filter_tag.find(".toggle-filter");e.on("click",function(){e.closest(".tag-filters-area").find(".filter-edit-area").show(),t.filter_edit_area.toggle()})}set_filter_button_text(){this.$filter_tag.find(".toggle-filter").html(this.get_filter_button_text())}get_filter_button_text(){var t=this.utils.get_formatted_value(this.field,this.get_selected_value());return __(this.field.df.label)+" "+__(this.get_condition())+" "+__(t)}get_filter_tag_element(){return $('<div class="filter-tag btn-group">\n\t\t\t<button class="btn btn-default btn-xs toggle-filter"\n\t\t\t\ttitle="'+__("Edit Filter")+'">\n\t\t\t</button>\n\t\t\t<button class="btn btn-default btn-xs remove-filter"\n\t\t\t\ttitle="'+__("Remove Filter")+'">\n\t\t\t\t<i class="fa fa-remove text-muted"></i>\n\t\t\t</button>\n\t\t</div>')}add_condition_help(t){var e=this.field.desc_area;e||(e=$('<div class="text-muted small">').appendTo(this.field.wrapper)),e.html(("in"===in_list(["in","not in"],t)?__("values separated by commas"):__("use % as wildcard"))+"</div>")}hide_invalid_conditions(t,e){for(var i=this.invalid_condition_map[e]||this.invalid_condition_map[t]||[],s=0,a=this.conditions;s<a.length;s+=1){var n=a[s];this.filter_edit_area.find('.condition option[value="'+n[0]+'"]').toggle(!i.includes(n[0]))}}toggle_nested_set_conditions(t){var e=this,i="Link"===t.fieldtype&&frappe.boot.nested_set_doctypes.includes(t.options);this.nested_set_conditions.forEach(function(t){e.filter_edit_area.find('.condition option[value="'+t[0]+'"]').toggle(i)})}},frappe.ui.filter_utils={get_formatted_value:function(t,e){return"docstatus"===t.df.fieldname?e={0:"Draft",1:"Submitted",2:"Cancelled"}[e]||e:"Check"===t.df.original_type&&(e={0:"No",1:"Yes"}[cint(e)]),frappe.format(e,t.df,{only_value:1})},get_selected_value:function(t,e){var i=t.get_value();return"string"==typeof i&&(i=strip(i)),"Check"==t.df.original_type&&(i="Yes"==i?1:0),-1!==e.indexOf("like","not like")?!i||i.startsWith("%")||i.endsWith("%")||(i="%"+i+"%"):in_list(["in","not in"],e)&&i&&(i=i.split(",").map(function(t){return strip(t)})),"%"===i&&(i=""),i},get_default_condition:function(t){return"Data"==t.fieldtype?"like":"Date"==t.fieldtype||"Datetime"==t.fieldtype?"Between":"="},set_fieldtype:function(t,e,i){t.original_type?t.fieldtype=t.original_type:t.original_type=t.fieldtype,t.description="",t.reqd=0,t.ignore_link_validation=!0,e?t.fieldtype=e:("docstatus"==t.fieldname?(t.fieldtype="Select",t.options=[{value:0,label:__("Draft")},{value:1,label:__("Submitted")},{value:2,label:__("Cancelled")}]):"Check"==t.fieldtype?(t.fieldtype="Select",t.options="No\nYes"):-1!=["Text","Small Text","Text Editor","Code","Tag","Comments","Dynamic Link","Read Only","Assign"].indexOf(t.fieldtype)?t.fieldtype="Data":"Link"==t.fieldtype&&-1==["=","!=","descendants of","ancestors of","not descendants of","not ancestors of"].indexOf(i)&&(t.fieldtype="Data"),"Data"===t.fieldtype&&"email"===(t.options||"").toLowerCase()&&(t.options=null),"Between"!=i||"Date"!=t.fieldtype&&"Datetime"!=t.fieldtype||(t.fieldtype="DateRange"),"is"===i&&(t.fieldtype="Select",t.options=[{label:__("Set"),value:"set"},{label:__("Not Set"),value:"not set"}]))}},frappe.ui.FilterGroup=class{constructor(t){$.extend(this,t),this.wrapper=this.parent,this.filters=[],this.make()}make(){this.wrapper.append(this.get_container_template()),this.set_events()}set_events(){var t=this;this.wrapper.find(".add-filter").on("click",function(){t.add_filter(t.doctype,"name")})}add_filters(t){for(var e=this,i=[],s=function(){var t=n[a];i.push(function(){var i;return(i=e).add_filter.apply(i,t)})},a=0,n=t;a<n.length;a+=1)s();return frappe.run_serially(i)}add_filter(t,e,i,s,a){if(!e)return Promise.resolve();if(!this.validate_args(t,e))return!1;var n=arguments.length<2;if(n&&this.wrapper.find(".new-filter:visible").length)return Promise.resolve();var r=[t,e,i,s,a],l=this.push_new_filter(r,n);return l&&l.then?l:Promise.resolve()}validate_args(t,e){return!(t&&e&&!frappe.meta.has_field(t,e)&&!frappe.model.std_fields_list.includes(e))||(frappe.throw(__('Invalid filter: "'+[e.bold()]+'"')),!1)}push_new_filter(t,e){var i;if(void 0===e&&(e=!1),!this.filter_exists(t)){var s=(i=this)._push_new_filter.apply(i,t);return s&&s.value?(s.setup_state(e),s._filter_value_set):void 0}}_push_new_filter(t,e,i,s,a){var n=this;void 0===a&&(a=!1);var r={parent:this.wrapper,parent_doctype:this.doctype,doctype:t,fieldname:e,condition:i,value:s,hidden:a,on_change:function(t){t&&n.update_filters(),n.on_change()},filter_items:function(t,e){return!n.filter_exists([t,e])}},l=new frappe.ui.Filter(r);return this.filters.push(l),l}filter_exists(t){var e=!1;return this.filters.filter(function(t){return t.field}).map(function(i){var s=i.get_value();if(2!==t.length){var a=t[3],n=frappe.utils.arrays_equal;(n(s.slice(0,4),t.slice(0,4))||Array.isArray(a)&&n(a,s[3]))&&(e=!0)}else e=t[0]===s[0]&&t[1]===s[1]}),e}get_filters(){return this.filters.filter(function(t){return t.field}).map(function(t){return t.freeze(),t.get_value()})}update_filters(){this.filters=this.filters.filter(function(t){return t.field})}clear_filters(){this.filters.map(function(t){return t.remove(!0)}),this.filters=[]}get_filter(t){return this.filters.filter(function(e){return e.field&&e.field.df.fieldname==t})[0]}get_container_template(){return $('<div class="tag-filters-area">\n\t\t\t<div class="active-tag-filters">\n\t\t\t\t<button class="btn btn-default btn-xs add-filter text-muted">\n\t\t\t\t\t\t'+__("Add Filter")+'\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="filter-edit-area"></div>')}},frappe.ui.FieldSelect=Class.extend({init:function(t){var e=this;if($.extend(this,t),this.fields_by_name={},this.options=[],this.$input=$('<input class="form-control">').appendTo(this.parent).on("click",function(){$(this).select()}),this.select_input=this.$input.get(0),this.awesomplete=new Awesomplete(this.select_input,{minChars:0,maxItems:99,autoFirst:!0,list:e.options,item:function(t){return $(repl('<li class="filter-field-select"><p>%(label)s</p></li>',t)).data("item.autocomplete",t).get(0)}}),this.$input.on("awesomplete-select",function(t){var i=t.originalEvent.text.value,s=e.awesomplete.get_item(i);e.selected_doctype=s.doctype,e.selected_fieldname=s.fieldname,e.select&&e.select(s.doctype,s.fieldname)}),this.$input.on("awesomplete-selectcomplete",function(t){var i=t.originalEvent.text.value,s=e.awesomplete.get_item(i);e.$input.val(s.label)}),this.filter_fields)for(var i in this.filter_fields)this.add_field_option(this.filter_fields[i]);else this.build_options();this.set_value(this.doctype,"name")},get_value:function(){return this.selected_doctype?this.selected_doctype+"."+this.selected_fieldname:null},val:function(t){if(void 0===t)return this.get_value();this.set_value(t)},clear:function(){this.selected_doctype=null,this.selected_fieldname=null,this.$input.val("")},set_value:function(t,e){var i=this;if(this.clear(),t){if(-1!==t.indexOf(".")){var s=t.split(".");t=s[0],e=s[1]}$.each(this.options,function(s,a){if(a.doctype===t&&a.fieldname===e)return i.selected_doctype=t,i.selected_fieldname=e,i.$input.val(a.label),!1})}},build_options:function(){var t=this;t.table_fields=[];var e=$.map(frappe.model.std_fields,function(e){var i={parent:t.doctype};return"name"==e.fieldname&&(i.options=t.doctype),$.extend(copy_dict(e),i)}),i=locals.DocType[t.doctype];i&&cint(i.istable)&&(e=e.concat([{fieldname:"parent",fieldtype:"Data",label:"Parent",parent:t.doctype}])),this.with_blank&&this.options.push({label:"",value:""});var s=e.concat(frappe.meta.docfield_list[t.doctype]);$.each(frappe.utils.sort(s,"label","string"),function(e,i){frappe.perm.has_perm(t.doctype,i.permlevel,"read")&&t.add_field_option(i)}),$.each(t.table_fields,function(e,i){if(i.options){var s=[].concat(frappe.meta.docfield_list[i.options]);$.each(frappe.utils.sort(s,"label","string"),function(e,i){frappe.perm.has_perm(t.doctype,i.permlevel,"read")&&t.add_field_option(i)})}})},add_field_option:function(t){if("docstatus"!=t.fieldname||frappe.model.is_submittable(this.doctype)){var e,i,s=this;s.doctype&&t.parent==s.doctype?(e=__(t.label),i=s.doctype,frappe.model.table_fields.includes(t.fieldtype)&&s.table_fields.push(t)):(e=__(t.label)+" ("+__(t.parent)+")",i=t.parent),-1!=frappe.model.no_value_type.indexOf(t.fieldtype)||s.fields_by_name[t.parent]&&s.fields_by_name[t.parent][t.fieldname]||(this.options.push({label:e,value:i+"."+t.fieldname,fieldname:t.fieldname,doctype:t.parent}),s.fields_by_name[t.parent]||(s.fields_by_name[t.parent]={}),s.fields_by_name[t.parent][t.fieldname]=t)}}}),frappe.templates.edit_filter='<div class="filter-box">  <div class="list_filter row">   <div class="fieldname-select-area col-sm-4 form-group ui-front"></div>   <div class="col-sm-2 form-group">    <select class="condition form-control">     {% for condition in conditions %}     <option value="{{condition[0]}}">{{ condition[1] }}</option>     {% endfor %}    </select>   </div>   <div class="col-sm-6 col-xs-12">    <div class="filter-field pull-left" style="width: calc(100% - 70px)"></div>    <div class="filter-actions pull-left">     <a class="set-filter-and-run btn btn-sm btn-primary pull-left">      <i class=" fa fa-check visible-xs"></i>      <span class="hidden-xs">{%= __("Apply") %}</span></a>     <a class="small grey remove-filter pull-left">      <i class="octicon octicon-trashcan visible-xs"></i>      <span class="hidden-xs">{%= __("Remove") %}</span></a>    </div>    <div class="clearfix"></div>   </div>  </div> </div> ',frappe.ui.Tags=class{constructor(t){var e=t.parent,i=t.placeholder,s=t.tagsList,a=t.onTagAdd,n=t.onTagRemove,r=t.onTagClick,l=t.onChange;this.tagsList=s||[],this.onTagAdd=a,this.onTagRemove=n,this.onTagClick=r,this.onChange=l,this.setup(e,i)}setup(t,e){this.$wrapper=$('<div class="tags-wrapper"></div>').appendTo(t),this.$ul=$('<ul class="tags-list"></ul>').appendTo(this.$wrapper),this.$input=$('<input class="tags-input"></input>'),this.$inputWrapper=this.getListElement(this.$input),this.$placeholder=this.getListElement($('<span class="tags-placeholder text-muted">'+e+"</span>")),this.$inputWrapper.appendTo(this.$ul),this.$placeholder.appendTo(this.$ul),this.deactivate(),this.bind(),this.boot()}bind(){var t=this;this.$input.keypress(function(e){if(13==e.which||13==e.keyCode){var i=frappe.utils.xss_sanitise(t.$input.val());t.addTag(i),t.$input.val("")}}),this.$input.on("blur",function(){t.deactivate()}),this.$placeholder.on("click",function(){t.activate(),t.$input.focus()})}boot(){this.addTags(this.tagsList)}activate(){this.$placeholder.hide(),this.$inputWrapper.show()}deactivate(){this.$inputWrapper.hide(),this.$placeholder.show()}addTag(t){if((t=toTitle(t))&&""!==t&&!this.tagsList.includes(t)){var e=this.getTag(t);this.getListElement(e).insertBefore(this.$inputWrapper),this.tagsList.push(t),this.onTagAdd&&this.onTagAdd(t)}}removeTag(t){t=frappe.utils.xss_sanitise(t),this.tagsList.includes(t)&&(this.tagsList.splice(this.tagsList.indexOf(t),1),this.onTagRemove&&this.onTagRemove(t))}addTags(t){t.map(this.addTag.bind(this))}clearTags(){this.$ul.find(".frappe-tag").remove(),this.tagsList=[]}getListElement(t,e){var i=$('<li class="tags-list-item '+e+'"></li>');return t.appendTo(i),i}getTag(t){var e=this,i=$('<div class="frappe-tag btn-group" data-tag-label="'+t+'">\n\t\t<button class="btn btn-default btn-xs toggle-tag"\n\t\t\ttitle="'+__("toggle Tag")+'"\n\t\t\tdata-tag-label="'+t+'">'+t+'\n\t\t</button>\n\t\t<button class="btn btn-default btn-xs remove-tag"\n\t\t\ttitle="'+__("Remove Tag")+'"\n\t\t\tdata-tag-label="'+t+'">\n\t\t\t<i class="fa fa-remove text-muted"></i>\n\t\t</button></div>'),s=i.find(".remove-tag");if(s.on("click",function(){e.removeTag(s.attr("data-tag-label")),s.closest(".tags-list-item").remove()}),this.onTagClick){var a=i.find(".toggle-tag");a.on("click",function(){e.onTagClick(a.attr("data-tag-label"))})}return i}},frappe.ui.TagEditor=Class.extend({init:function(t){$.extend(this,t),this.setup_tags(),this.user_tags||(this.user_tags=""),this.initialized=!0,this.refresh(this.user_tags)},setup_tags:function(){var t=this;this.parent&&(this.wrapper=$('<div class="tag-line" style="position: relative">').appendTo(this.parent),this.wrapper.length&&(this.tags=new frappe.ui.Tags({parent:this.wrapper,placeholder:__("Add a tag ..."),onTagAdd:function(e){if(t.initialized&&!t.refreshing)return frappe.call({method:"frappe.desk.tags.add_tag",args:t.get_args(e),callback:function(i){var s=t.user_tags?t.user_tags.split(","):[];s.push(e),t.user_tags=s.join(","),t.on_change&&t.on_change(t.user_tags)}})},onTagRemove:function(e){if(!t.refreshing)return frappe.call({method:"frappe.desk.tags.remove_tag",args:t.get_args(e),callback:function(i){var s=t.user_tags.split(",");s.splice(s.indexOf(e),1),t.user_tags=s.join(","),t.on_change&&t.on_change(t.user_tags)}})}}),this.setup_awesomplete(),this.setup_complete=!0))},setup_awesomplete:function(){var t=this,e=this.wrapper.find("input.tags-input"),i=e.get(0);this.awesomplete=new Awesomplete(i,{minChars:0,maxItems:99,list:[]}),e.on("awesomplete-open",function(t){e.attr("state","open")}),e.on("awesomplete-close",function(t){e.attr("state","closed")}),e.on("input",function(e){var i=e.target.value;frappe.call({method:"frappe.desk.tags.get_tags",args:{doctype:t.frm.doctype,txt:i.toLowerCase(),cat_tags:t.list_sidebar?JSON.stringify(t.list_sidebar.get_cat_tags()):"[]"},callback:function(e){t.awesomplete.list=e.message}})}),e.on("focus",function(t){"open"!=e.attr("state")&&e.trigger("input")})},get_args:function(t){return{tag:t,dt:this.frm.doctype,dn:this.frm.docname}},refresh:function(t){var e=this;if(this.initialized&&this.setup_complete&&!this.refreshing){e.refreshing=!0;try{e.tags.clearTags(),t&&(e.user_tags=t,e.tags.addTags(t.split(",")))}catch(t){e.refreshing=!1,setTimeout(function(){e.refresh()},100)}e.refreshing=!1}}}),frappe.ui.is_liked=function(t){return-1!==frappe.ui.get_liked_by(t).indexOf(frappe.session.user)},frappe.ui.get_liked_by=function(t){var e=t._liked_by;return e&&(e=JSON.parse(e)),e||[]},frappe.ui.toggle_like=function(t,e,i,s){var a=t.hasClass("not-liked")?"Yes":"No";t.css("pointer-events","none"),frappe.call({method:"frappe.desk.like.toggle_like",quiet:!0,args:{doctype:e,name:i,add:a},callback:function(n){if(t.css("pointer-events","auto"),!n.exc){var r=$('.like-action[data-name="'+i.replace(/"/g,'"')+'"][data-doctype="'+e.replace(/"/g,'"')+'"]');"Yes"===a?r.removeClass("not-liked text-extra-muted"):r.addClass("not-liked text-extra-muted");var l=locals[e]&&locals[e][i];if(l){var o=JSON.parse(l._liked_by||"[]"),d=o.indexOf(frappe.session.user);"Yes"===a?-1===d&&o.push(frappe.session.user):-1!==d&&(o=o.slice(0,d).concat(o.slice(d+1))),l._liked_by=JSON.stringify(o)}s&&s()}}})},frappe.ui.click_toggle_like=function(){var t=$(this),e=t.siblings(".likes-count"),i=t.hasClass("not-liked"),s=t.attr("data-doctype"),a=t.attr("data-name");return frappe.ui.toggle_like(t,s,a,function(){i?e.text(cint(e.text())+1):e.text(cint(e.text())-1)}),!1},frappe.ui.setup_like_popover=function(t,e,i){void 0===i&&(i=!0),frappe.dom.is_touchscreen()||t.on("mouseover",e,function(){var t=$(this);t.popover({animation:!0,placement:"right",trigger:"manual",template:'<div class="liked-by-popover popover">\n\t\t\t\t<div class="arrow"></div>\n\t\t\t\t<div class="popover-content"></div>\n\t\t\t</div>',content:function(){var e=t.attr("data-liked-by");e=e?decodeURI(e):"[]",e=JSON.parse(e);var s=frappe.session.user;if(i&&(t.find(".not-liked").length?-1!==e.indexOf(s)&&e.splice(e.indexOf(s),1):-1===e.indexOf(s)&&e.push(s)),!e.length)return"";var a=$('<ul class="list-unstyled"></ul>');return e.forEach(function(t){a.append("\n\t\t\t\t\t\t<li data-user="+t+">"+frappe.avatar(t)+"\n\t\t\t\t\t\t\t<span>"+frappe.user.full_name(t)+"</span>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t")}),a.children("li").click(function(e){var i=e.currentTarget.dataset.user;t.popover("hide"),frappe.set_route("#social/profile/"+i)}),a},html:!0,container:"body"}),t.popover("show"),$(".popover").on("mouseleave",function(){t.popover("hide")}),t.on("mouseout",function(){setTimeout(function(){$(".popover:hover").length||t.popover("hide")},100)})})},frappe.templates.print_template='<!DOCTYPE html> <html lang="en">   <head>     <meta charset="utf-8">     <meta http-equiv="X-UA-Compatible" content="IE=edge">     <meta name="viewport" content="width=device-width, initial-scale=1">     <meta name="description" content="">     <meta name="author" content="">     <title>{{ title }}</title>     <link href="{{ base_url }}/assets/frappe/css/bootstrap.css" rel="stylesheet">  <link type="text/css" rel="stylesheet"         href="{{ base_url }}/assets/frappe/css/font-awesome.css">  <style>   {{ print_css }}  </style>   </head>   <body>    <div class="print-format-gutter">     {% if print_settings.repeat_header_footer %}    <div id="footer-html" class="visible-pdf">     {% if print_settings.letter_head && print_settings.letter_head.footer %}      <div class="letter-head-footer">       {{ print_settings.letter_head.footer }}      </div>     {% endif %}     <p class="text-center small page-number visible-pdf">      {{ __("Page {0} of {1}", [`<span class="page"></span>`, `<span class="topage"></span>`]) }}     </p>    </div>     {% endif %}      <div class="print-format {% if landscape %} landscape {% endif %}"     {% if columns.length > 20 %}      style="font-size: 4.0pt"     {% endif %}    >      {% if print_settings.letter_head %}      <div {% if print_settings.repeat_header_footer %} id="header-html" class="hidden-pdf" {% endif %}>       <div class="letter-head">{{ print_settings.letter_head.header }}</div>      </div>      {% endif %}          {{ content }}     </div>    </div>   </body> </html> ',frappe.provide("frappe.views"),frappe.views.BaseList=class{constructor(t){Object.assign(this,t)}show(){var t=this;frappe.run_serially([function(){return t.init()},function(){return t.before_refresh()},function(){return t.refresh()}])}init(){var t=this;if(this.init_promise)return this.init_promise;var e=[this.setup_defaults,this.set_stats,this.setup_fields,this.setup_page,this.setup_side_bar,this.setup_main_section,this.setup_view].map(function(e){return e.bind(t)});return this.init_promise=frappe.run_serially(e),this.init_promise}setup_defaults(){var t=this;this.page_name=frappe.get_route_str(),this.page_title=this.page_title||__(this.doctype),this.meta=frappe.get_meta(this.doctype),this.settings=frappe.listview_settings[this.doctype]||{},this.user_settings=frappe.get_user_settings(this.doctype),this.start=0,this.page_length=20,this.data=[],this.method="frappe.desk.reportview.get",this.can_create=frappe.model.can_create(this.doctype),this.can_write=frappe.model.can_write(this.doctype),this.fields=[],this.filters=[],this.sort_by="modified",this.sort_order="desc",this.primary_action=null,this.secondary_action={label:__("Refresh"),action:function(){return t.refresh()}},this.menu_items=[{label:__("Refresh"),action:function(){return t.refresh()},class:"visible-xs"}]}setup_fields(){this.set_fields(),this.build_fields()}set_fields(){var t=this;[].concat(frappe.model.std_fields_list,this.meta.title_field).forEach(function(e){return t._add_field(e)})}get_fields_in_list_view(){var t=this;return this.meta.fields.filter(function(e){return frappe.model.is_value_type(e.fieldtype)&&e.in_list_view&&frappe.perm.has_perm(t.doctype,e.permlevel,"read")||"Currency"===e.fieldtype&&e.options&&!e.options.includes(":")||"status"===e.fieldname})}build_fields(){var t=this;this.fields=this.fields.map(function(e){return"string"==typeof e&&(e=[e,t.doctype]),e}),this.fields=this.fields.filter(Boolean),this.fields=this.fields.uniqBy(function(t){return t[0]+t[1]})}_add_field(t){if(t){var e=this.doctype;if("object"==typeof t){var i=t;t=i.fieldname,e=i.parent}(frappe.model.std_fields_list.includes(t)||frappe.meta.has_field(e,t)||"_seen"===t)&&this.fields.push([t,e])}}set_stats(){this.stats=["_user_tags"],this.workflow_state_fieldname=frappe.workflow.get_state_fieldname(this.doctype),this.workflow_state_fieldname&&(frappe.workflow.workflows[this.doctype].override_status||this._add_field(this.workflow_state_fieldname),this.stats.push(this.workflow_state_fieldname))}setup_page(){this.page=this.parent.page,this.$page=$(this.parent),this.page.page_form.removeClass("row").addClass("flex"),this.setup_page_head()}setup_page_head(){this.set_title(),this.set_menu_items(),this.set_breadcrumbs()}set_title(){this.page.set_title(this.page_title)}set_menu_items(){var t=this,e=this.page.set_secondary_action(this.secondary_action.label,this.secondary_action.action,this.secondary_action.icon);this.secondary_action.icon?e.addClass("visible-xs"):e.addClass("hidden-xs"),this.menu_items.map(function(e){if(!e.condition||!1!==e.condition()){var i=t.page.add_menu_item(e.label,e.action,e.standard,e.shortcut);e.class&&i&&i.addClass(e.class)}})}set_breadcrumbs(){frappe.breadcrumbs.add(this.meta.module,this.doctype)}setup_side_bar(){this.list_sidebar=new frappe.views.ListSidebar({doctype:this.doctype,stats:this.stats,parent:this.$page.find(".layout-side-section"),page:this.page,list_view:this})}toggle_side_bar(){this.list_sidebar.parent.toggleClass("hide"),this.page.current_view.find(".layout-main-section-wrapper").toggleClass("col-md-10 col-md-12")}setup_main_section(){var t=this;return frappe.run_serially([this.setup_list_wrapper,this.setup_filter_area,this.setup_sort_selector,this.setup_result_area,this.setup_no_result_area,this.setup_freeze_area,this.setup_paging_area].map(function(e){return e.bind(t)}))}setup_list_wrapper(){this.$frappe_list=$('<div class="frappe-list">').appendTo(this.page.main)}setup_filter_area(){if(this.filter_area=new FilterArea(this),this.filters.length>0)return this.filter_area.set(this.filters)}setup_sort_selector(){this.sort_selector=new frappe.ui.SortSelector({parent:this.filter_area.$filter_list_wrapper,doctype:this.doctype,args:{sort_by:this.sort_by,sort_order:this.sort_order},onchange:this.on_sort_change.bind(this)})}on_sort_change(){this.refresh()}setup_result_area(){this.$result=$('<div class="result">'),this.$frappe_list.append(this.$result)}setup_no_result_area(){this.$no_result=$('\n\t\t\t<div class="no-result text-muted flex justify-center align-center">\n\t\t\t\t'+this.get_no_result_message()+"\n\t\t\t</div>\n\t\t").hide(),this.$frappe_list.append(this.$no_result)}setup_freeze_area(){this.$freeze=$('<div class="freeze"></div>').hide(),this.$frappe_list.append(this.$freeze)}get_no_result_message(){return __("Nothing to show")}setup_paging_area(){var t=this;this.$paging_area=$('<div class="list-paging-area level">\n\t\t\t\t<div class="level-left">\n\t\t\t\t\t<div class="btn-group">\n\t\t\t\t\t\t'+[20,100,500].map(function(t){return'\n\t\t\t\t\t\t\t<button type="button" class="btn btn-default btn-sm btn-paging"\n\t\t\t\t\t\t\t\tdata-value="'+t+'">\n\t\t\t\t\t\t\t\t'+t+"\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t"}).join("")+'\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="level-right">\n\t\t\t\t\t<button class="btn btn-default btn-more btn-sm">\n\t\t\t\t\t\t'+__("More")+"...\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>").hide(),this.$frappe_list.append(this.$paging_area),this.$paging_area.find('.btn-paging[data-value="'+this.page_length+'"]').addClass("btn-info"),this.$paging_area.on("click",".btn-paging, .btn-more",function(e){var i=$(e.currentTarget);i.is(".btn-paging")?(t.$paging_area.find(".btn-paging").removeClass("btn-info"),i.addClass("btn-info"),t.start=0,t.page_length=i.data().value,t.refresh()):i.is(".btn-more")&&(t.start=t.start+t.page_length,t.refresh())})}get_fields(){return this.fields.map(function(t){return frappe.model.get_full_column_name(t[0],t[1])})}setup_view(){}get_filters_for_args(){return this.filter_area?this.filter_area.get().map(function(t){return t.slice(0,4)}):[]}get_args(){return{doctype:this.doctype,fields:this.get_fields(),filters:this.get_filters_for_args(),order_by:this.sort_selector.get_sql_string(),start:this.start,page_length:this.page_length}}get_call_args(){var t=this.get_args();return{method:this.method,args:t,freeze:this.freeze_on_refresh||!1,freeze_message:this.freeze_message||__("Loading")+"..."}}before_refresh(){}refresh(){var t=this;return this.freeze(!0),frappe.call(this.get_call_args()).then(function(e){t.prepare_data(e),t.toggle_result_area(),t.before_render(),t.render(),t.after_render(),t.freeze(!1),t.settings.refresh&&t.settings.refresh(t)})}prepare_data(t){var e=t.message||{};e=Array.isArray(e)?e:frappe.utils.dict(e.keys,e.values),0===this.start?this.data=e:this.data=this.data.concat(e),this.data=this.data.uniqBy(function(t){return t.name})}freeze(){}before_render(){}after_render(){}render(){}on_filter_change(){}toggle_result_area(){this.$result.toggle(this.data.length>0),this.$paging_area.toggle(this.data.length>0),this.$no_result.toggle(0==this.data.length);var t=this.start+this.page_length<=this.data.length;this.$paging_area.find(".btn-more").toggle(t)}call_for_selected_items(t,e){var i=this;void 0===e&&(e={}),e.names=this.get_checked_items(!0),frappe.call({method:t,args:e,freeze:!0,callback:function(t){t.exc||i.refresh()}})}};class FilterArea{constructor(t){this.list_view=t,this.standard_filters_wrapper=this.list_view.page.page_form,this.$filter_list_wrapper=$('<div class="filter-list">').appendTo(this.list_view.$frappe_list),this.trigger_refresh=!0,this.setup()}setup(){this.make_standard_filters(),this.make_filter_list()}get(){var t=this.filter_list.get_filters(),e=this.get_standard_filters();return t.concat(e).uniqBy(JSON.stringify)}set(t){var e=this;return this.trigger_refresh=!1,this.add(t,!1).then(function(){e.trigger_refresh=!0})}add(t,e){var i=this;if(void 0===e&&(e=!0),!t||Array.isArray(t)&&0===t.length)return Promise.resolve();"string"==typeof t[0]&&(t=[Array.from(arguments)]);t=t.filter(function(t){return!i.exists(t)});var s=this.set_standard_filter(t),a=s.non_standard_filters;return s.promise.then(function(){return a.length>0&&i.filter_list.add_filters(a)}).then(function(){e&&i.list_view.refresh()})}refresh_list_view(){this.trigger_refresh&&(this.list_view.start=0,this.list_view.refresh(),this.list_view.on_filter_change())}exists(t){var e=!1,i=this.list_view.page.fields_dict;"="===t[2]&&t[1]in i&&(i[t[1]].get_value()&&(e=!0));return e||(e=this.filter_list.filter_exists(t)),e}set_standard_filter(t){if(0===t.length)return{non_standard_filters:[],promise:Promise.resolve()};var e=this.list_view.page.fields_dict;return t.reduce(function(t,i){i[0];var s=i[1],a=i[2],n=i[3];return t.promise=t.promise||Promise.resolve(),t.non_standard_filters=t.non_standard_filters||[],e[s]&&"="===a?t.promise=t.promise.then(function(){return e[s].set_value(n)}):t.non_standard_filters.push(i),t},{})}remove(t){var e=this.list_view.page.fields_dict;if(t in e)return e[t].set_value("");var i=this.filter_list.get_filter(t);return i&&i.remove(),Promise.resolve()}clear(t){var e=this;void 0===t&&(t=!0),t||(this.trigger_refresh=!1),this.filter_list.clear_filters();var i=[],s=this.list_view.page.fields_dict,a=function(t){var s=e.list_view.page.fields_dict[t];i.push(function(){return s.set_value("")})};for(var n in s)a(n);return frappe.run_serially(i).then(function(){e.trigger_refresh=!0})}make_standard_filters(){var t=this,e=[{fieldtype:"Data",label:"ID",condition:"like",fieldname:"name",onchange:function(){return t.refresh_list_view()}}];this.list_view.custom_filter_configs&&(this.list_view.custom_filter_configs.forEach(function(e){e.onchange=function(){return t.refresh_list_view()}}),e=e.concat(this.list_view.custom_filter_configs));var i=this.list_view.meta.fields;(e=e.concat(i.filter(function(t){return t.in_standard_filter&&frappe.model.is_value_type(t.fieldtype)}).map(function(e){var i=e.options,s="=",a=e.fieldtype;["Text","Small Text","Text Editor","Data"].includes(a)&&(a="Data",s="like"),"Select"==e.fieldtype&&e.options&&(i=e.options.split("\n")).length>0&&""!=i[0]&&(i.unshift(""),i=i.join("\n"));var n="Link"===a?frappe.defaults.get_user_default(i):null;return["__default","__global"].includes(n)&&(n=null),{fieldtype:a,label:__(e.label),options:i,fieldname:e.fieldname,condition:s,default:n,onchange:function(){return t.refresh_list_view()},ignore_link_validation:"Dynamic Link"===a}}))).map(function(e){return t.list_view.page.add_field(e)}),$('<span class="octicon octicon-search text-muted small"></span>').appendTo(this.list_view.page.fields_dict.name.$wrapper).css({position:"absolute","z-index":"1",right:"7px",top:"9px","font-size":"90%"}),this.list_view.page.fields_dict.name.$wrapper.find(".form-control").css("padding-right","2em")}get_standard_filters(){var t=[],e=this.list_view.page.fields_dict;for(var i in e){var s=e[i],a=s.get_value();a&&("like"!==s.df.condition||a.includes("%")||(a="%"+a+"%"),t.push([this.list_view.doctype,s.df.fieldname,s.df.condition||"=",a]))}return t}make_filter_list(){var t=this;this.filter_list=new frappe.ui.FilterGroup({base_list:this.list_view,parent:this.$filter_list_wrapper,doctype:this.list_view.doctype,default_filters:[],on_change:function(){return t.refresh_list_view()}})}is_being_edited(){return this.filter_list&&this.filter_list.wrapper.find(".filter-box:visible").length>0}}frappe.views.view_modes=["List","Gantt","Kanban","Calendar","Image","Inbox","Report"],frappe.views.is_valid=function(t){return frappe.views.view_modes.includes(t)};class BulkOperations{constructor(t){var e=t.doctype;e||frappe.throw(__("Doctype required")),this.doctype=e}print(t){var e=this,i=frappe.model.get_doc(":Print Settings","Print Settings"),s=cint(i.allow_print_for_draft),a=frappe.model.is_submittable(this.doctype),n=cint(i.allow_print_for_cancelled),r=t.filter(function(t){return!a||1===t.docstatus||n&&2==t.docstatus||s&&0==t.docstatus||frappe.user.has_role("Administrator")}).map(function(t){return t.name});if(t.filter(function(t){return!r.includes(t.name)}).length>0)frappe.msgprint(__("You selected Draft or Cancelled documents"));else if(r.length>0){var l=new frappe.ui.Dialog({title:__("Print Documents"),fields:[{fieldtype:"Check",label:__("With Letterhead"),fieldname:"with_letterhead"},{fieldtype:"Select",label:__("Print Format"),fieldname:"print_sel",options:frappe.meta.get_print_formats(this.doctype)}]});l.set_primary_action(__("Print"),function(t){if(t){var i=frappe.get_meta(e.doctype).default_print_format,s=t.with_letterhead?1:0,a=t.print_sel?t.print_sel:i,n=JSON.stringify(r);window.open("/api/method/frappe.utils.print_format.download_multi_pdf?doctype="+encodeURIComponent(e.doctype)+"&name="+encodeURIComponent(n)+"&format="+encodeURIComponent(a)+"&no_letterhead="+(s?"0":"1"))||frappe.msgprint(__("Please enable pop-ups"))}}),l.show()}else frappe.msgprint(__("Select atleast 1 record for printing"))}delete(t,e){void 0===e&&(e=null),frappe.call({method:"frappe.desk.reportview.delete_items",freeze:!0,args:{items:t,doctype:this.doctype}}).then(function(i){var s=i.message;s||(s=[]),s.length&&!i._server_messages&&frappe.throw(__("Cannot delete {0}",[s.map(function(t){return t.bold()}).join(", ")])),s.length<t.length&&(frappe.utils.play_sound("delete"),e&&e())})}assign(t,e){if(t.length>0){var i=new frappe.ui.form.AssignToDialog({obj:this,method:"frappe.desk.form.assign_to.add_multiple",doctype:this.doctype,docname:t,bulk_assign:!0,re_assign:!0,callback:e});i.dialog.clear(),i.dialog.show()}else frappe.msgprint(__("Select records for assignment"))}submit_or_cancel(t,e,i){void 0===e&&(e="submit"),void 0===i&&(i=null),e=e.toLowerCase(),frappe.call({method:"frappe.desk.doctype.bulk_update.bulk_update.submit_cancel_or_update_docs",args:{doctype:this.doctype,action:e,docnames:t}}).then(function(s){var a=s.message;a||(a=[]),a.length&&!s._server_messages&&frappe.throw(__("Cannot {0} {1}",[e,a.map(function(t){return t.bold()}).join(", ")])),a.length<t.length&&(frappe.utils.play_sound(e),i&&i())})}edit(t,e,i){var s=this,a=Object.keys(e).sort(),n=/status/i,r=a.find(function(t){return n.test(t)}),l=new frappe.ui.Dialog({title:__("Edit"),fields:[{fieldtype:"Select",options:a,default:r,label:__("Field"),fieldname:"field",reqd:1,onchange:function(){o(l)}},{fieldtype:"Data",label:__("Value"),fieldname:"value",reqd:1}],primary_action:function(a){var n,r=a.value,o=e[l.get_value("field")].fieldname;l.disable_primary_action(),frappe.call({method:"frappe.desk.doctype.bulk_update.bulk_update.submit_cancel_or_update_docs",args:{doctype:s.doctype,freeze:!0,docnames:t,action:"update",data:(n={},n[o]=r,n)}}).then(function(t){var e=t.message||[];e.length&&!t._server_messages&&(l.enable_primary_action(),frappe.throw(__("Cannot update {0}",[e.map(function(t){return t.bold?t.bold():t}).join(", ")]))),i(),l.hide(),frappe.show_alert(__("Updated successfully"))})},primary_action_label:__("Update")});function o(t){var i=Object.assign({},e[t.get_value("field")]);if(i.label.match(n)&&"Select"===i.fieldtype&&!i.default){var s=[];"string"==typeof i.options&&(s=i.options.split("\n")),i.default=s[0]||s[1]}i.label=__("Value"),i.reqd=1,delete i.depends_on,t.replace_field("value",i)}r&&o(l),l.refresh(),l.show()}}frappe.provide("frappe.views"),frappe.views.ListView=class extends frappe.views.BaseList{static load_last_view(){var t=frappe.get_route(),e=t[1];if(2===t.length){var i=frappe.get_user_settings(e).last_view;return frappe.set_route("List",e,frappe.views.is_valid(i)?i:"List"),!0}return!1}constructor(t){super(t),this.show()}has_permissions(){return frappe.perm.has_perm(this.doctype,0,"read")}show(){if(!this.has_permissions())return frappe.set_route(""),void frappe.msgprint(__("Not permitted to view "+this.doctype));super.show()}get view_name(){return"List"}get view_user_settings(){return this.user_settings[this.view_name]||{}}setup_defaults(){var t=this;if(super.setup_defaults(),this.sort_by=this.view_user_settings.sort_by||"modified",this.sort_order=this.view_user_settings.sort_order||"desc",this.view_user_settings.filters&&this.view_user_settings.filters.length){var e=this.view_user_settings.filters;this.filters=this.validate_filters(e)}else this.filters=(this.settings.filters||[]).map(function(e){return 3===e.length&&(e=[t.doctype,e[0],e[1],e[2]]),e});if(this.menu_items=this.menu_items.concat(this.get_menu_items()),this.view_user_settings.filters&&this.view_user_settings.filters.length){var i=this.view_user_settings.filters;this.filters=this.validate_filters(i)}else this.filters=(this.settings.filters||[]).map(function(e){return 3===e.length&&(e=[t.doctype,e[0],e[1],e[2]]),e});return this.patch_refresh_and_load_lib(),this.get_list_view_settings()}get_list_view_settings(){var t=this;return frappe.call("frappe.desk.listview.get_list_settings",{doctype:this.doctype}).then(function(e){return t.list_view_settings=e.message||{}})}on_sort_change(t,e){this.sort_by=t,this.sort_order=e,super.on_sort_change()}validate_filters(t){var e=this.meta.fields.map(function(t){return t.fieldname});return t.filter(function(t){return e.includes(t[1])}).uniqBy(function(t){return t[1]})}setup_page(){this.parent.list_view=this,super.setup_page()}setup_page_head(){super.setup_page_head(),this.set_primary_action(),this.set_actions_menu_items()}set_actions_menu_items(){var t=this;this.actions_menu_items=this.get_actions_menu_items(),this.workflow_action_menu_items=this.get_workflow_action_menu_items(),this.workflow_action_items={},this.actions_menu_items.concat(this.workflow_action_menu_items).map(function(e){var i=t.page.add_actions_menu_item(e.label,e.action,e.standard);e.class&&i.addClass(e.class),e.is_workflow_action&&i&&(t.workflow_action_items[e.name]=i)})}show_restricted_list_indicator_if_applicable(){var t=this,e=frappe.perm.get_match_rules(this.doctype);e.length&&(this.restricted_list=$('<button class="restricted-list form-group">Restricted</button>').prepend('<span class="octicon octicon-lock"></span>').click(function(){return t.show_restrictions(e)}).appendTo(this.page.page_form))}show_restrictions(t){void 0===t&&(t=[]),frappe.msgprint(frappe.render_template("list_view_permission_restrictions",{condition_list:t}),"Restrictions")}set_fields(){var t=this;[].concat(frappe.model.std_fields_list,this.get_fields_in_list_view(),[this.meta.title_field,this.meta.image_field],this.settings.add_fields||[],this.meta.track_seen?"_seen":null,this.sort_by,"enabled","disabled","color").forEach(function(e){return t._add_field(e)}),this.fields.forEach(function(e){var i=frappe.meta.get_docfield(e[1],e[0]);i&&"Currency"===i.fieldtype&&i.options&&!i.options.includes(":")&&t._add_field(i.options)})}patch_refresh_and_load_lib(){var t=this;this.refresh=this.refresh.bind(this),this.refresh=frappe.utils.throttle(this.refresh,1e3),this.load_lib=new Promise(function(e){t.required_libs?frappe.require(t.required_libs,e):e()});setInterval(function(){frappe.get_route_str()===t.page_name&&t.refresh()},3e5)}set_primary_action(){var t=this;this.can_create?this.page.set_primary_action(__("New"),function(){t.settings.primary_action?t.settings.primary_action():t.make_new_doc()},"octicon octicon-plus"):this.page.clear_primary_action()}make_new_doc(){var t=this.doctype,e={};this.filter_area.get().forEach(function(t){"="===t[2]&&frappe.model.is_non_std_field(t[1])&&(e[t[1]]=t[3])}),frappe.new_doc(t,e)}setup_view(){this.setup_columns(),this.render_header(),this.render_skeleton(),this.setup_events(),this.settings.onload&&this.settings.onload(this),this.show_restricted_list_indicator_if_applicable()}setup_freeze_area(){this.$freeze=$('<div class="freeze flex justify-center align-center text-muted">'+__("Loading")+"...</div>").hide(),this.$result.append(this.$freeze)}setup_columns(){var t=this;this.columns=[];var e=frappe.meta.get_docfield.bind(null,this.doctype);this.meta.title_field?this.columns.push({type:"Subject",df:e(this.meta.title_field)}):this.columns.push({type:"Subject",df:{label:__("Name"),fieldname:"name"}}),frappe.has_indicator(this.doctype)&&this.columns.push({type:"Status"});var i=this.get_fields_in_list_view();this.columns=this.columns.concat(i.filter(function(e){return(!frappe.has_indicator(t.doctype)||"status"!==e.fieldname)&&(!!e.in_list_view&&e.fieldname!==t.meta.title_field)}).map(function(t){return{type:"Field",df:t}})),this.columns=this.columns.slice(0,4)}get_no_result_message(){var t=this.can_create?'<p><button class="btn btn-primary btn-sm btn-new-doc">\n\t\t\t\t'+__("Create a new {0}",[__(this.doctype)])+"\n\t\t\t</button></p>":"";return'<div class="msg-box no-border">\n\t\t\t<p>'+__("No {0} found",[__(this.doctype)])+"</p>\n\t\t\t"+t+"\n\t\t</div>"}freeze(){this.list_view_settings&&!this.list_view_settings.disable_count&&this.$result.find(".list-count").html("<span>"+__("Refreshing")+"...</span>")}get_args(){var t=super.get_args();return Object.assign(t,{with_comment_count:!0})}before_refresh(){var t=this;return frappe.route_options&&(this.filters=this.parse_filters_from_route_options(),frappe.route_options=null,this.filters.length>0)?this.filter_area.clear(!1).then(function(){return t.filter_area.set(t.filters)}):Promise.resolve()}parse_filters_from_settings(){var t=this;return(this.settings.filters||[]).map(function(e){return 3===e.length&&(e=[t.doctype,e[0],e[1],e[2]]),e})}toggle_result_area(){super.toggle_result_area(),this.toggle_actions_menu_button(this.$result.find(".list-row-check:checked").length>0)}toggle_actions_menu_button(t){t?(this.page.show_actions_menu(),this.page.clear_primary_action(),this.toggle_workflow_actions()):(this.page.hide_actions_menu(),this.set_primary_action())}render_header(){0===this.$result.find(".list-row-head").length&&this.$result.prepend(this.get_header_html())}render_skeleton(){var t=this.get_list_row_html_skeleton('<div><input type="checkbox" /></div>');this.$result.append(t)}before_render(){this.settings.before_render&&this.settings.before_render(),frappe.model.user_settings.save(this.doctype,"last_view",this.view_name),this.save_view_user_settings({filters:this.filter_area.get(),sort_by:this.sort_selector.sort_by,sort_order:this.sort_selector.sort_order})}render(){var t=this;this.$result.find(".list-row-container").remove(),this.data.length>0&&this.$result.append(this.data.map(function(e,i){return e._idx=i,t.get_list_row_html(e)}).join("")),this.on_row_checked(),this.render_count(),this.render_tags()}render_count(){var t=this;this.list_view_settings.disable_count||this.get_count_str().then(function(e){t.$result.find(".list-count").html("<span>"+e+"</span>")})}render_tags(){var t=this,e=this.$result.find(".list-row-container");this.data.forEach(function(i,s){var a=$("<div class='tag-row'>\n\t\t\t\t<div class='list-tag hidden-xs'></div>\n\t\t\t</div>").appendTo(e.get(s));new frappe.ui.TagEditor({parent:a.find(".list-tag"),frm:{doctype:t.doctype,docname:i.name},list_sidebar:t.list_sidebar,user_tags:i._user_tags,on_change:function(t){i._user_tags=t}}).wrapper.on("click",".tagit-label",function(e){var i=$(e.currentTarget);t.filter_area.add(t.doctype,"_user_tags","=",i.text())})})}get_header_html(){var t=this.columns[0].df,e='\n\t\t\t<input class="level-item list-check-all hidden-xs" type="checkbox" title="'+__("Select All")+'">\n\t\t\t<span class="level-item list-liked-by-me">\n\t\t\t\t<i class="octicon octicon-heart text-extra-muted" title="'+__("Likes")+'"></i>\n\t\t\t</span>\n\t\t\t<span class="level-item">'+__(t.label)+"</span>\n\t\t",i=this.columns.map(function(t){return'\n\t\t\t\t<div class="'+["list-row-col ellipsis","Subject"==t.type?"list-subject level":"hidden-xs",frappe.model.is_numeric_field(t.df)?"text-right":""].join(" ")+'">\n\t\t\t\t\t'+("Subject"===t.type?e:"\n\t\t\t\t\t<span>"+__(t.df&&t.df.label||t.type)+"</span>")+"\n\t\t\t\t</div>\n\t\t\t"}).join("");return this.get_header_html_skeleton(i,'<span class="list-count"></span>')}get_header_html_skeleton(t,e){return void 0===t&&(t=""),void 0===e&&(e=""),'\n\t\t\t<header class="level list-row list-row-head text-muted small">\n\t\t\t\t<div class="level-left list-header-subject">\n\t\t\t\t\t'+t+'\n\t\t\t\t</div>\n\t\t\t\t<div class="level-left checkbox-actions">\n\t\t\t\t\t<div class="level list-subject">\n\t\t\t\t\t\t<input class="level-item list-check-all hidden-xs" type="checkbox" title="'+__("Select All")+'">\n\t\t\t\t\t\t<span class="level-item list-header-meta"></span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="level-right">\n\t\t\t\t\t'+e+"\n\t\t\t\t</div>\n\t\t\t</header>\n\t\t"}get_left_html(t){var e=this;return this.columns.map(function(i){return e.get_column_html(i,t)}).join("")}get_right_html(t){return this.get_meta_html(t)}get_list_row_html(t){return this.get_list_row_html_skeleton(this.get_left_html(t),this.get_right_html(t))}get_list_row_html_skeleton(t,e){return void 0===t&&(t=""),void 0===e&&(e=""),'\n\t\t\t<div class="list-row-container" tabindex="1">\n\t\t\t\t<div class="level list-row small">\n\t\t\t\t\t<div class="level-left ellipsis">\n\t\t\t\t\t\t'+t+'\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="level-right text-muted ellipsis">\n\t\t\t\t\t\t'+e+"\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"}get_column_html(t,e){if("Status"===t.type)return'\n\t\t\t\t<div class="list-row-col hidden-xs ellipsis">\n\t\t\t\t\t'+this.get_indicator_html(e)+"\n\t\t\t\t</div>\n\t\t\t";var i,s,a=t.df||{},n=a.label,r=a.fieldname,l=e[r]||"",o=this.settings.formatters;return'\n\t\t\t<div class="'+["list-row-col ellipsis",{Subject:"list-subject level",Field:"hidden-xs"}[t.type],frappe.model.is_numeric_field(a)?"text-right":""].join(" ")+'">\n\t\t\t\t'+{Subject:this.get_subject_html(e),Field:(s="string"==typeof l?frappe.utils.escape_html(l):l,i="Image"===a.fieldtype?a.options?'<img src="'+e[a.options]+'" style="max-height: 30px; max-width: 100%;">':'<div class="missing-image small">\n\t\t\t\t\t\t<span class="octicon octicon-circle-slash"></span>\n\t\t\t\t\t</div>':"Select"===a.fieldtype?'<span class="filterable indicator '+frappe.utils.guess_colour(s)+' ellipsis"\n\t\t\t\t\tdata-filter="'+r+",=,"+l+'">\n\t\t\t\t\t'+__(s)+"\n\t\t\t\t</span>":"Link"===a.fieldtype?'<a class="filterable text-muted ellipsis"\n\t\t\t\t\tdata-filter="'+r+",=,"+l+'">\n\t\t\t\t\t'+s+"\n\t\t\t\t</a>":"Text Editor"===a.fieldtype?'<span class="text-muted ellipsis">\n\t\t\t\t\t'+s+"\n\t\t\t\t</span>":'<a class="filterable text-muted ellipsis"\n\t\t\t\t\tdata-filter="'+r+",=,"+l+'">\n\t\t\t\t\t'+(o&&o[r]?o[r](l,a,e):"Code"===a.fieldtype?l:"Percent"===a.fieldtype?'<div class="progress level" style="margin: 0px;">\n\t\t\t\t\t\t<div class="progress-bar progress-bar-success" role="progressbar"\n\t\t\t\t\t\t\taria-valuenow="'+l+'"\n\t\t\t\t\t\t\taria-valuemin="0" aria-valuemax="100" style="width: '+Math.round(l)+'%;">\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>':frappe.format(l,a,null,e))+"\n\t\t\t\t</a>",'<span class="ellipsis"\n\t\t\t\ttitle="'+__(n)+": "+s+'">\n\t\t\t\t'+i+"\n\t\t\t</span>")}[t.type]+"\n\t\t\t</div>\n\t\t"}get_meta_html(t){var e="";this.settings.hide_name_column||t[this.meta.title_field||""]===t.name||(e+='\n\t\t\t\t<div class="level-item hidden-xs hidden-sm ellipsis">\n\t\t\t\t\t<a class="text-muted ellipsis" href="'+this.get_form_link(t)+'">\n\t\t\t\t\t\t'+t.name+"\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t"),this.settings.button&&this.settings.button.show(t)&&(e+='\n\t\t\t\t<div class="level-item hidden-xs">\n\t\t\t\t\t<button class="btn btn-action btn-default btn-xs"\n\t\t\t\t\t\tdata-name="'+t.name+'" data-idx="'+t._idx+'"\n\t\t\t\t\t\ttitle="'+this.settings.button.get_description(t)+'">\n\t\t\t\t\t\t'+this.settings.button.get_label(t)+"\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t");var i=comment_when(t.modified,!0),s=JSON.parse(t._assign||"[]").slice(-1)[0];return e+='\n\t\t\t<div class="level-item hidden-xs list-row-activity">\n\t\t\t\t'+i+"\n\t\t\t\t"+(s?'<span class="filterable"\n\t\t\t\tdata-filter="_assign,like,%'+s+'%">\n\t\t\t\t'+frappe.avatar(s)+"\n\t\t\t</span>":'<span class="avatar avatar-small avatar-empty"></span>')+"\n\t\t\t\t"+('<span class="'+(t._comment_count?"":"text-extra-muted")+' comment-count">\n\t\t\t\t<i class="octicon octicon-comment-discussion"></i>\n\t\t\t\t'+(t._comment_count>99?"99+":t._comment_count)+"\n\t\t\t</span>")+'\n\t\t\t</div>\n\t\t\t<div class="level-item visible-xs text-right">\n\t\t\t\t'+this.get_indicator_dot(t)+"\n\t\t\t</div>\n\t\t"}get_count_str(){var t=this,e=this.data.length,i=this.data.uniqBy(function(t){return t.name}).length,s=this.get_filters_for_args(),a=["count("+(s.some(function(e){return e[0]!==t.doctype})?"distinct":"")+frappe.model.get_full_column_name("name",this.doctype)+") AS total_count"];return frappe.call({type:"GET",method:this.method,args:{doctype:this.doctype,filters:s,fields:a}}).then(function(s){t.total_count=s.message.values[0][0]||e;var a=__("{0} of {1}",[e,t.total_count]);return i!==e&&(a=__("{0} of {1} ({2} rows with children)",[i,t.total_count,e])),a})}get_form_link(t){if(this.settings.get_form_link)return this.settings.get_form_link(t);var e=t.name.match(/[%'"]/)?encodeURIComponent(t.name):t.name;return"#Form/"+this.doctype+"/"+e}get_subject_html(t){var e=frappe.session.user,i=t[this.columns[0].df.fieldname]||t.name,s=strip_html(i),a=frappe.utils.escape_html(s),n=JSON.parse(t._liked_by||"[]"),r=n.includes(e)?"liked-by":"text-extra-muted not-liked",l=JSON.parse(t._seen||"[]").includes(e)?"":"bold";return'\n\t\t\t<input class="level-item list-row-checkbox hidden-xs" type="checkbox" data-name="'+escape(t.name)+'">\n\t\t\t<span class="level-item" style="margin-bottom: 1px;">\n\t\t\t\t<i class="octicon octicon-heart like-action '+r+'"\n\t\t\t\t\tdata-name="'+t.name+'" data-doctype="'+this.doctype+'"\n\t\t\t\t\tdata-liked-by="'+(encodeURI(t._liked_by)||"[]")+'"\n\t\t\t\t>\n\t\t\t\t</i>\n\t\t\t\t<span class="likes-count">\n\t\t\t\t\t'+(n.length>99?__("99")+"+":__(n.length||""))+'\n\t\t\t\t</span>\n\t\t\t</span>\n\t\t\t<span class="level-item '+l+' ellipsis" title="'+a+'">\n\t\t\t\t<a class="ellipsis" href="'+this.get_form_link(t)+'" title="'+a+'" data-doctype="'+this.doctype+'" data-name="'+t.name+'">\n\t\t\t\t'+s+"\n\t\t\t\t</a>\n\t\t\t</span>\n\t\t"}get_indicator_html(t){var e=frappe.get_indicator(t,this.doctype);return e?'<span class="indicator '+e[1]+" filterable\"\n\t\t\t\tdata-filter='"+e[2]+"'>\n\t\t\t\t"+__(e[0])+"\n\t\t\t<span>":""}get_indicator_dot(t){var e=frappe.get_indicator(t,this.doctype);return e?"<span class='indicator "+e[1]+"' title='"+__(e[0])+"'></span>":""}setup_events(){this.setup_filterable(),this.setup_list_click(),this.setup_tag_event(),this.setup_new_doc_event(),this.setup_check_events(),this.setup_like(),this.setup_realtime_updates(),this.setup_action_handler(),this.setup_keyboard_navigation()}setup_keyboard_navigation(){var t=this,e=function(){$(document.activeElement).next().focus()},i=function(){$(document.activeElement).prev().focus()},s=function(t){t.find("input[type=checkbox]").click()},a=function(){return $(document.activeElement).is(".list-row-container")?$(document.activeElement):null},n=function(){return t.page.wrapper.is(":visible")},r=function(){return $(document.activeElement).is("input")},l=function(s){if(!n()||r())return!1;a()?"down"===s?e():i():t.$result.find(".list-row-container:first").focus()};frappe.ui.keys.add_shortcut({shortcut:"down",action:function(){return l("down")},description:__("Navigate list down"),page:this.page}),frappe.ui.keys.add_shortcut({shortcut:"up",action:function(){return l("up")},description:__("Navigate list up"),page:this.page}),frappe.ui.keys.add_shortcut({shortcut:"shift+down",action:function(){if(!n()||r())return!1;var t=a();s(t),e()},description:__("Select multiple list items"),page:this.page}),frappe.ui.keys.add_shortcut({shortcut:"shift+up",action:function(){if(!n()||r())return!1;var t=a();s(t),i()},description:__("Select multiple list items"),page:this.page}),frappe.ui.keys.add_shortcut({shortcut:"enter",action:function(){var t=a();return!!t&&(t.find("a[data-name]")[0].click(),!0)},description:__("Open list item"),page:this.page}),frappe.ui.keys.add_shortcut({shortcut:"space",action:function(){var t=a();return!!t&&(s(t),!0)},description:__("Select list item"),page:this.page})}setup_filterable(){var t=this;this.$result.on("click",".filterable",function(e){if(!e.metaKey&&!e.ctrlKey){e.stopPropagation();var i=$(e.currentTarget).attr("data-filter").split("|").map(function(e){return"Today"===(e=e.split(","))[2]?e[2]=frappe.datetime.get_today():"User"==e[2]&&(e[2]=frappe.session.user),[t.doctype,e[0],e[1],e.slice(2).join(",")]});t.filter_area.add(i)}})}setup_list_click(){var t=this;this.$result.on("click",".list-row, .image-view-header",function(e){var i=$(e.target);if(e.ctrlKey||e.metaKey&&!i.is("a")){var s=$(e.currentTarget).find(".list-row-checkbox");return s.prop("checked",!s.prop("checked")),e.preventDefault(),void t.on_row_checked()}if(!(i.hasClass("filterable")||i.hasClass("octicon-heart")||i.is(":checkbox")||i.is("a"))){var a=$(e.currentTarget).find(".list-subject a").get(0);return a?(window.location.href=a.href,!1):void 0}})}setup_action_handler(){var t=this;this.$result.on("click",".btn-action",function(e){var i=$(e.currentTarget),s=t.data[i.attr("data-idx")];return t.settings.button.action(s),e.stopPropagation(),!1})}setup_check_events(){var t=this;this.$result.on("change","input[type=checkbox]",function(e){var i=$(e.currentTarget);if(i.is(".list-header-subject .list-check-all")){var s=t.$result.find(".checkbox-actions .list-check-all");s.prop("checked",i.prop("checked")),s.trigger("change")}else if(i.is(".checkbox-actions .list-check-all")){t.$result.find(".list-header-subject .list-check-all").prop("checked",i.prop("checked")),t.$result.find(".list-row-checkbox").prop("checked",i.prop("checked"))}t.on_row_checked()}),this.$result.on("click",".list-row-checkbox",function(e){var i,s=$(e.currentTarget);if(e.shiftKey&&t.$checkbox_cursor&&!s.is(t.$checkbox_cursor)){var a=t.$checkbox_cursor.data().name,n=s.data().name,r=[t.data.findIndex(function(t){return t.name===a}),t.data.findIndex(function(t){return t.name===n})],l=r[0],o=r[1];l>o&&(l=(i=[o,l])[0],o=i[1]);var d=t.data.slice(l+1,o).map(function(t){return t.name}).map(function(t){return'.list-row-checkbox[data-name="'+t+'"]'}).join(",");t.$result.find(d).prop("checked",!0)}t.$checkbox_cursor=s})}setup_like(){var t=this;this.$result.on("click",".like-action",frappe.ui.click_toggle_like),this.$result.on("click",".list-liked-by-me",function(e){var i=$(e.currentTarget);i.toggleClass("active"),i.hasClass("active")?t.filter_area.add(t.doctype,"_liked_by","like","%"+frappe.session.user+"%"):t.filter_area.remove("_liked_by")}),frappe.ui.setup_like_popover(this.$result,".liked-by")}setup_new_doc_event(){var t=this;this.$no_result.find(".btn-new-doc").click(function(){t.settings.primary_action?t.settings.primary_action():t.make_new_doc()})}setup_tag_event(){var t=this;this.list_sidebar.parent.on("click",".list-tag-preview",function(){t.toggle_tags()})}setup_realtime_updates(){var t=this;this.list_view_settings.disable_auto_refresh||frappe.realtime.on("list_update",function(e){if(!t.filter_area.is_being_edited()){var i=e.doctype,s=e.name;if(i===t.doctype){var a=t.get_call_args();a.args.filters.push([t.doctype,"name","=",s]),a.args.start=0,frappe.call(a).then(function(e){var i=e.message;if(i){var a=frappe.utils.dict(i.keys,i.values);if(!a||!a.length)return t.data=t.data.filter(function(t){return t.name!==s}),void t.render();var n=a[0],r=t.data.findIndex(function(t){return t.name===n.name});-1===r?t.data.push(n):t.data[r]=n,t.data.sort(function(e,i){var s=e[t.sort_by]||"",a=i[t.sort_by]||"",n=0;return s>a&&(n=1),a>s&&(n=-1),"desc"===t.sort_order&&(n=-n),n}),t.toggle_result_area(),t.render()}})}}})}on_row_checked(){this.$list_head_subject=this.$list_head_subject||this.$result.find("header .list-header-subject"),this.$checkbox_actions=this.$checkbox_actions||this.$result.find("header .checkbox-actions"),this.$checks=this.$result.find(".list-row-checkbox:checked"),this.$list_head_subject.toggle(0===this.$checks.length),this.$checkbox_actions.toggle(this.$checks.length>0),0===this.$checks.length?this.$list_head_subject.find(".list-check-all").prop("checked",!1):(this.$checkbox_actions.find(".list-header-meta").html(__("{0} items selected",[this.$checks.length])),this.$checkbox_actions.show(),this.$list_head_subject.hide()),this.toggle_actions_menu_button(this.$checks.length>0)}toggle_tags(){this.$result.toggleClass("tags-shown")}get_checked_items(t){var e=Array.from(this.$checks||[]).map(function(t){return cstr(unescape($(t).data().name))});return t?e:this.data.filter(function(t){return e.includes(t.name)})}save_view_user_settings(t){return frappe.model.user_settings.save(this.doctype,this.view_name,t)}on_update(){}get_share_url(){var t=this.get_filters_for_args().map(function(t){return t[3]=encodeURIComponent(t[3]),"="===t[2]?t[1]+"="+t[3]:[t[1],"=",JSON.stringify([t[2],t[3]])].join("")}).join("&"),e=window.location.href;return t&&(e+="?"+t),e}share_url(){new frappe.ui.Dialog({title:__("Share URL"),fields:[{fieldtype:"Code",fieldname:"url",label:"URL",default:this.get_share_url(),read_only:1}]}).show()}get_menu_items(){var t=this,e=this.doctype,i=[];return frappe.model.can_import(e)&&i.push({label:__("Import"),action:function(){return frappe.set_route("List","Data Import",{reference_doctype:e})},standard:!0}),frappe.model.can_set_user_permissions(e)&&i.push({label:__("User Permissions"),action:function(){return frappe.set_route("List","User Permission",{allow:e})},standard:!0}),frappe.user_roles.includes("System Manager")&&(i.push({label:__("Role Permissions Manager"),action:function(){return frappe.set_route("permission-manager",{doctype:e})},standard:!0}),i.push({label:__("Customize"),action:function(){t.meta&&(t.meta.custom?frappe.set_route("Form","DocType",e):t.meta.custom||frappe.set_route("Form","Customize Form",{doc_type:e}))},standard:!0,shortcut:"Ctrl+J"})),i.push({label:__("Toggle Sidebar"),action:function(){return t.toggle_side_bar()},standard:!0,shortcut:"Ctrl+K"}),i.push({label:__("Share URL"),action:function(){return t.share_url()},standard:!0,shortcut:"Ctrl+L"}),frappe.user.has_role("System Manager")&&1===frappe.boot.developer_mode&&i.push({label:__("Edit DocType"),action:function(){return frappe.set_route("Form","DocType",e)},standard:!0}),frappe.user.has_role("System Manager")&&i.push({label:__("Settings"),action:function(){return t.show_list_settings()},standard:!0}),i}show_list_settings(){var t=this;frappe.model.with_doctype("List View Setting",function(){var e=new frappe.ui.Dialog({title:__("Settings"),fields:frappe.get_meta("List View Setting").fields});e.set_values(t.list_view_settings),e.show(),e.set_primary_action(__("Save"),function(){var i=e.get_values();frappe.call("frappe.desk.listview.set_list_settings",{doctype:t.doctype,values:i}),Object.assign(t.list_view_settings,i),e.hide()})})}get_workflow_action_menu_items(){var t=this,e=[];frappe.model.has_workflow(this.doctype)&&frappe.workflow.get_all_transition_actions(this.doctype).forEach(function(i){e.push({label:__(i),name:i,action:function(){frappe.xcall("frappe.model.workflow.bulk_workflow_approval",{docnames:t.get_checked_items(!0),doctype:t.doctype,action:i})},is_workflow_action:!0})});return e}toggle_workflow_actions(){var t=this;if(frappe.model.has_workflow(this.doctype)){var e=this.get_checked_items();frappe.xcall("frappe.model.workflow.get_common_transition_actions",{docs:e,doctype:this.doctype}).then(function(e){Object.keys(t.workflow_action_items).forEach(function(i){t.workflow_action_items[i].toggle(e.includes(i))})})}}get_actions_menu_items(){var t=this,e=this.doctype,i=[],s=new BulkOperations({doctype:this.doctype}),a=function(t){return t.fieldname&&frappe.model.is_value_type(t)&&"Read Only"!==t.fieldtype&&!t.hidden&&!t.read_only};return function(t){return frappe.meta.get_docfields(t).some(function(t){return a(t)})}(e)&&i.push({label:__("Edit"),action:function(){var i={};frappe.meta.get_docfields(e).forEach(function(t){a(t)&&(i[t.label]=Object.assign({},t))});var n=t.get_checked_items(!0);s.edit(n,i,t.refresh)},standard:!0}),i.push({label:__("Assign To"),action:function(){return s.assign(t.get_checked_items(!0),t.refresh)},standard:!0}),frappe.model.can_print(e)&&i.push({label:__("Print"),action:function(){return s.print(t.get_checked_items())},standard:!0}),frappe.model.is_submittable(e)&&function(t){return frappe.perm.has_perm(t,0,"submit")}(e)&&i.push({label:__("Submit"),action:function(){var e=t.get_checked_items(!0);e.length>0&&frappe.confirm(__("Submit {0} documents?",[e.length]),function(){return s.submit_or_cancel(e,"submit",t.refresh)})},standard:!0}),frappe.model.can_cancel(e)&&i.push({label:__("Cancel"),action:function(){var e=t.get_checked_items(!0);e.length>0&&frappe.confirm(__("Cancel {0} documents?",[e.length]),function(){return s.submit_or_cancel(e,"cancel",t.refresh)})},standard:!0}),frappe.model.can_delete(e)&&i.push({label:__("Delete"),action:function(){var e=t.get_checked_items(!0).map(function(t){return t.toString()});frappe.confirm(__("Delete {0} items permanently?",[e.length]),function(){return s.delete(e,t.refresh)})},standard:!0}),i}parse_filters_from_route_options(){var t=[];for(var e in frappe.route_options){var i=null,s=frappe.route_options[e],a=void 0;if($.isArray(s)&&s[0].startsWith("[")&&s[0].endsWith("]")){a=[];for(var n=0;n<s.length;n++)a.push(JSON.parse(s[n]))}else"string"==typeof s&&s.startsWith("[")&&s.endsWith("]")&&(s=JSON.parse(s));if(e.includes(".")&&(i=e.split(".")[0],e=e.split(".")[1]),i||(i=frappe.meta.get_doctype_for_field(this.doctype,e)),i)if(a)for(var r=0;r<a.length;r++)$.isArray(a[r])?t.push([i,e,a[r][0],a[r][1]]):t.push([i,e,"=",a[r]]);else $.isArray(s)?t.push([i,e,s[0],s[1]]):t.push([i,e,"=",s])}return t}static trigger_list_update(t){var e=t.doctype;if(e)if(frappe.provide("frappe.views.trees"),frappe.views.trees[e])frappe.views.trees[e].tree.refresh();else{var i=frappe.get_route_str(),s=frappe.views.list_view[i];s&&s.on_update(t)}}},$(document).on("save",function(t,e){frappe.views.ListView.trigger_list_update(e)}),frappe.provide("frappe.views.list_view"),window.cur_list=null,frappe.views.ListFactory=class extends frappe.views.Factory{make(t){var e=this,i=t[1];frappe.model.with_doctype(i,function(){if(locals.DocType[i].issingle)frappe.set_re_route("Form",i);else{var s="File"!==i?t[2]:"File",a=frappe.views[s+"View"];if(a||(a=frappe.views.ListView),a&&a.load_last_view&&a.load_last_view())return;frappe.provide("frappe.views.list_view."+i);var n=frappe.get_route_str();frappe.views.list_view[n]?frappe.container.change_to(n):frappe.views.list_view[n]=new a({doctype:i,parent:e.make_page(!0,n)}),e.set_cur_list()}})}show(){this.re_route_to_view()||(this.set_module_breadcrumb(),super.show(),this.set_cur_list(),cur_list&&cur_list.show())}re_route_to_view(){var t=frappe.get_route(),e=t[1],i=frappe.route_history.slice(-2)[0];if("List"===t[0]&&2===t.length&&frappe.views.list_view[e])return!(!i||"List"!==i[0]||i[1]!==e)&&(window.history.go(-1),!0)}set_module_breadcrumb(){if(frappe.route_history.length>1){var t=frappe.route_history[frappe.route_history.length-2];if("modules"===t[0]){var e=frappe.get_route()[1],i=t[1];frappe.module_links[i]&&frappe.module_links[i].includes(e)&&frappe.breadcrumbs.set_doctype_module(e,i)}}}set_cur_list(){var t=frappe.get_route(),e=frappe.get_route_str();cur_list=frappe.views.list_view[e],cur_list&&cur_list.doctype!==t[1]&&(window.cur_list=null)}},frappe.provide("frappe.ui");class ListFilter{constructor(t){t.wrapper,t.doctype;Object.assign(this,arguments[0]),this.can_add_global=frappe.user.has_role(["System Manager","Administrator"]),this.filters=[],this.make(),this.bind(),this.refresh()}make(){this.wrapper.html('<li class="input-area"></li>'),this.$input_area=this.wrapper.find(".input-area"),this.$list_filters=this.wrapper.find(".list-filters"),this.filter_input=frappe.ui.form.make_control({df:{fieldtype:"Data",label:__("Save Filter").toUpperCase(),placeholder:__("Filter Name"),input_class:"input-xs"},parent:this.$input_area,render_input:1}),$(this.filter_input.label_area).css("font-size",10),this.is_global_input=frappe.ui.form.make_control({df:{fieldtype:"Check",label:__("Is Global")},parent:this.$input_area,render_input:1})}bind(){this.bind_save_filter(),this.bind_click_filter(),this.bind_remove_filter()}refresh(){var t=this;this.get_list_filters().then(function(){var e=t.filters.map(function(e){return t.filter_template(e)});t.wrapper.find(".list-link").remove(),t.wrapper.append(e)}),this.is_global_input.toggle(!1),this.filter_input.set_description("")}filter_template(t){return'<li class="list-link" data-name="'+t.name+'">\n\t\t\t<a style="max-width: 90%;">'+t.filter_name+'</a>\n\t\t\t<a class="text-muted pull-right"><span class="remove octicon octicon-x"></span></a>\n\t\t</li>'}bind_click_filter(){var t=this;this.wrapper.on("click",".list-link",function(e){var i=$(e.currentTarget).attr("data-name");t.list_view.filter_area.clear().then(function(){t.list_view.filter_area.add(t.get_filters_values(i))})})}bind_remove_filter(){var t=this;this.wrapper.on("click",".list-link .remove",function(e){var i=$(e.currentTarget).closest(".list-link"),s=i.attr("data-name");i.remove(),t.remove_filter(s).then(function(){return t.refresh()})})}bind_save_filter(){var t=this;this.filter_input.$input.keydown(frappe.utils.debounce(function(e){var i=t.filter_input.get_value(),s=Boolean(i);if(e.which===frappe.ui.keyCode.ENTER){if(!s||t.filter_name_exists(i))return;t.filter_input.set_value(""),t.save_filter(i).then(function(){return t.refresh()})}else{var a=__("Press Enter to save");t.filter_name_exists(i)&&(a=__("Duplicate Filter Name")),t.filter_input.set_description(s?a:""),t.can_add_global&&t.is_global_input.toggle(s)}},300))}save_filter(t){return frappe.db.insert({doctype:"List Filter",reference_doctype:this.list_view.doctype,filter_name:t,for_user:this.is_global_input.get_value()?"":frappe.session.user,filters:JSON.stringify(this.get_current_filters())})}remove_filter(t){if(t)return frappe.db.delete_doc("List Filter",t)}get_filters_values(t){var e=this.filters.find(function(e){return e.name===t});return JSON.parse(e.filters||"[]")}get_current_filters(){return this.list_view.filter_area.get()}filter_name_exists(t){return(this.filters||[]).find(function(e){return e.filter_name===t})}get_list_filters(){var t=this;return frappe.db.get_list("List Filter",{fields:["name","filter_name","for_user","filters"],filters:{reference_doctype:this.list_view.doctype},or_filters:[["for_user","=",frappe.session.user],["for_user","=",""]]}).then(function(e){t.filters=e||[]})}}function redirect_to_home_if_invalid_route(){return"List"===frappe.get_route()[2]&&(frappe.set_route("List","File","Home"),!0)}function get_doc_mappings(){return{Event:{field_map:{interaction_type:"doctype",summary:"subject",description:"description",category:"event_category",due_date:"starts_on",public:"event_type"},reqd_fields:["summary","due_date"],hidden_fields:[]},ToDo:{field_map:{interaction_type:"doctype",description:"description",due_date:"date",reference_doctype:"reference_type",reference_document:"reference_name",assigned_to:"owner"},reqd_fields:["description"],hidden_fields:["public","category"]}}}frappe.provide("frappe.views"),frappe.views.ListSidebar=class{constructor(t){$.extend(this,t),this.make(),this.cat_tags=[]}make(){var t=this,e=frappe.render_template("list_sidebar",{doctype:this.doctype});this.sidebar=$('<div class="list-sidebar overlay-sidebar hidden-xs hidden-sm"></div>').html(e).appendTo(this.page.sidebar.empty()),this.setup_reports(),this.setup_list_filter(),this.setup_views(),this.setup_kanban_boards(),this.setup_calendar_view(),this.setup_email_inbox(),this.setup_keyboard_shortcuts(),this.setup_list_group_by(),$(document).trigger("list_sidebar_setup"),this.list_view.list_view_settings&&this.list_view.list_view_settings.disable_sidebar_stats?this.sidebar.find(".sidebar-stat").remove():this.sidebar.find(".list-stats").on("click",function(e){$(e.currentTarget).find(".stat-link").remove(),t.get_stats()})}setup_views(){var t=!1;frappe.views.calendar[this.doctype]&&(this.sidebar.find('.list-link[data-view="Calendar"]').removeClass("hide"),this.sidebar.find('.list-link[data-view="Gantt"]').removeClass("hide"),t=!0),this.sidebar.find('.list-link[data-view="Kanban"]').removeClass("hide"),"Communication"===this.doctype&&frappe.boot.email_accounts.length&&(this.sidebar.find('.list-link[data-view="Inbox"]').removeClass("hide"),t=!0),frappe.treeview_settings[this.doctype]&&this.sidebar.find(".tree-link").removeClass("hide"),this.current_view="List";var e=frappe.get_route();e.length>2&&frappe.views.view_modes.includes(e[2])&&(this.current_view=e[2],"Kanban"===this.current_view?this.kanban_board=e[3]:"Inbox"===this.current_view&&(this.email_account=e[3])),this.sidebar.find('.list-link[data-view="'+this.current_view+'"] a').attr("disabled","disabled").addClass("disabled"),this.sidebar.find('.list-link[data-view="Kanban"] a, .list-link[data-view="Inbox"] a').attr("disabled",null).removeClass("disabled"),this.list_view.meta.image_field&&(this.sidebar.find('.list-link[data-view="Image"]').removeClass("hide"),t=!0),t&&this.sidebar.find('.list-link[data-view="List"]').removeClass("hide")}setup_reports(){var t=this,e=[],i=this.page.sidebar.find(".reports-dropdown"),s=!1,a=function(a){$.each(a,function(a,n){if(!n.ref_doctype||n.ref_doctype==t.doctype){var r="Report Builder"===n.report_type?"List/"+n.ref_doctype+"/Report":"query-report",l=n.route||r+"/"+(n.title||n.name);-1===e.indexOf(l)&&(e.push(l),s||(t.get_divider().appendTo(i),s=!0),$('<li><a href="#'+l+'">'+__(n.title||n.name)+"</a></li>").appendTo(i))}})};this.list_view.settings.reports&&a(this.list_view.settings.reports),a(Object.values(frappe.boot.user.all_reports).sort(function(t,e){return t.title.localeCompare(e.title)})||[])}setup_list_filter(){this.list_filter=new ListFilter({wrapper:this.page.sidebar.find(".list-filters"),doctype:this.doctype,list_view:this.list_view})}setup_kanban_boards(){var t=this.page.sidebar.find(".kanban-dropdown");frappe.views.KanbanView.setup_dropdown_in_sidebar(this.doctype,t)}setup_calendar_view(){var t=this,e=this.doctype;frappe.db.get_list("Calendar View",{filters:{reference_doctype:e}}).then(function(i){if(i){var s=i,a=t.sidebar.find('.list-link[data-view="Calendar"]'),n="";frappe.views.calendar[t.doctype]&&(n='<li><a href="#List/'+e+'/Calendar/Default">\n\t\t\t\t\t'+__("Default")+"</a></li>");var r=s.map(function(t){return'<li><a href="#List/'+e+"/Calendar/"+t.name+'">\n\t\t\t\t\t'+__(t.name)+"</a>\n\t\t\t\t</li>"}).join(""),l='\n\t\t\t\t<div class="btn-group">\n\t\t\t\t\t<a class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n\t\t\t\t\t\t'+__("Calendar")+' <span class="caret"></span>\n\t\t\t\t\t</a>\n\t\t\t\t\t<ul class="dropdown-menu calendar-dropdown" style="max-height: 300px; overflow-y: auto;">\n\t\t\t\t\t\t'+n+"\n\t\t\t\t\t\t"+r+"\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t";a.removeClass("hide"),a.html(l)}})}setup_email_inbox(){var t=this;if("Communication"==this.doctype){var e=this.page.sidebar.find(".email-account-dropdown"),i=!1;has_common(frappe.user_roles,["System Manager","Administrator"])&&$('<li class="new-email-account"><a>'+__("New Email Account")+"</a></li>").appendTo(e),frappe.boot.email_accounts.forEach(function(s){var a=["List","Communication","Inbox","All Accounts"==s.email_id?"All Accounts":s.email_account].join("/");i||(t.get_divider().appendTo(e),i=!0),$('<li><a href="#'+a+'">'+s.email_id+"</a></li>").appendTo(e),"Sent Mail"===s.email_id&&(i=!1)}),e.find(".new-email-account").click(function(){frappe.new_doc("Email Account")})}}setup_keyboard_shortcuts(){var t=this;this.sidebar.find(".list-link > a, .list-link > .btn-group > a").each(function(e,i){frappe.ui.keys.get_shortcut_group(t.page).add($(i))})}setup_list_group_by(){this.list_group_by=new frappe.views.ListGroupBy({doctype:this.doctype,sidebar:this,list_view:this.list_view,page:this.page})}setup_dropdown_search(t,e){var i=t.find(".dropdown-search").show(),s=i.find(".dropdown-search-input");s.focus(),i.on("click",function(t){t.stopPropagation()});var a=t.find("li");i.on("keyup",function(){var t=s.val().toLowerCase();t=t.replace(/^\s+|\s+$/g,"");for(var i=0;i<a.length;i++){var n=a.eq(i).find(e),r=n.text().toLowerCase(),l=n.data("name").toLowerCase();r.includes(t)||l.includes(t)?a.eq(i).css("display",""):a.eq(i).css("display","none")}}),t.parent().on("hide.bs.dropdown",function(){i.val("")})}get_cat_tags(){return this.cat_tags}get_stats(){var t=this;frappe.call({method:"frappe.desk.reportview.get_sidebar_stats",type:"GET",args:{stats:t.stats,doctype:t.doctype,filters:t.default_filters||[]},callback:function(e){if(t.defined_category=e.message,e.message.defined_cat){for(var i in t.defined_category=e.message.defined_cat,t.cats={},t.defined_category)void 0===t.cats[t.defined_category[i].category]?t.cats[t.defined_category[i].category]=[t.defined_category[i].tag]:t.cats[t.defined_category[i].category].push(t.defined_category[i].tag),t.cat_tags[i]=t.defined_category[i].tag;t.tempstats=e.message.stats,$.each(t.cats,function(e,i){t.render_stat(e,(t.tempstats||{})._user_tags,i)}),t.render_stat("_user_tags",(t.tempstats||{})._user_tags)}else t.render_stat("_user_tags",(e.message.stats||{})._user_tags);var s=t.sidebar.find(".list-stats-dropdown");t.setup_dropdown_search(s,".stat-label")}})}render_stat(t,e,i){var s=this,a=0,n=[],r=frappe.meta.docfield_map[this.doctype][t]?frappe.meta.docfield_map[this.doctype][t].label:t;if(e=(e||[]).sort(function(t,e){return e[1]-t[1]}),$.each(e,function(t,e){a+=e[1]}),i){for(var l in i){var o=-1;for(var d in e)if(i[l]===e[d][0]){n.push(e[d]),o=d;break}o<0?n.push([i[l],0]):s.tempstats._user_tags.splice(o,1)}t="_user_tags"}else n=e;var p={field:t,stat:n,sum:a,label:"_user_tags"===t?i?__(r):__("Tags"):__(r)};$(frappe.render_template("list_sidebar_stat",p)).on("click",".stat-link",function(){var t=$(this).attr("data-field"),e=$(this).attr("data-label"),i="like",a=s.list_view.filter_area.filter_list.get_filter(t);a&&a.remove(),"No Tags"==e&&(e="%,%",i="not like"),s.list_view.filter_area.filter_list.add_filter(s.list_view.doctype,t,i,e).then(function(){s.list_view.refresh()})}).appendTo(this.sidebar.find(".list-stats-dropdown"))}set_fieldtype(t){"docstatus"==t.fieldname?(t.fieldtype="Select",t.options=[{value:0,label:"Draft"},{value:1,label:"Submitted"},{value:2,label:"Cancelled"}]):"Check"==t.fieldtype?(t.fieldtype="Select",t.options=[{value:0,label:"No"},{value:1,label:"Yes"}]):-1!=["Text","Small Text","Text Editor","Code","Tag","Comments","Dynamic Link","Read Only","Assign"].indexOf(t.fieldtype)?t.fieldtype="Data":"Link"==t.fieldtype&&"="!=this.$w.find(".condition").val()&&(t.fieldtype="Data"),"Data"===t.fieldtype&&"email"===(t.options||"").toLowerCase()&&(t.options=null)}reload_stats(){this.sidebar.find(".sidebar-stat").remove(),this.get_stats()}get_divider(){return $('<li role="separator" class="divider"></li>')}},frappe.templates.list_sidebar='<ul class="list-unstyled sidebar-menu visible-sm visible-xs">  <li>   <a class="navbar-home" href="#">    <img class="app-logo" src="{{ frappe.app.logo_url }}">   </a>  </li> </ul> <ul class="list-unstyled sidebar-menu user-actions hide">  <li class="divider"></li> </ul> <ul class="list-unstyled sidebar-menu standard-actions">  {% if frappe.model.can_get_report(doctype) %}  <li class="divider visible-sm visible-xs"></li>  <li class="list-link">   <div class="btn-group">    <a class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" href="#" onclick="return false;">     {{ __("Reports") }} <span class="caret"></span>    </a>    <ul class="dropdown-menu reports-dropdown" role="menu">     <li><a href="#List/{{ doctype }}/Report">{{ __("Report Builder") }}</a></li>    </ul>   </div>  </li>  {% endif %}  <li class="divider"></li>  <li class="list-link" data-view="List">   <a href="#List/{%= doctype %}/List">{%= __("List") %}</a></li>  <li class="hide list-link" data-view="Image">   <a href="#List/{%= doctype %}/Image">{%= __("Images") %}</a></li>  <li class="hide list-link" data-view="Gantt">   <a href="#List/{%= doctype %}/Gantt">{%= __("Gantt") %}</a></li>  <li class="hide tree-link">   <a href="#Tree/{%= doctype %}">{%= __("Tree") %}</a></li>  <li class="hide list-link" data-view="Calendar">   <a href="#List/{%= doctype %}/Calendar">{%= __("Calendar") %}</a></li>  <li class="hide list-link" data-view="Kanban">   <div class="btn-group">    <a class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" href="#" onclick="return false;">     {{ __("Kanban") }} <span class="caret"></span>    </a>    <ul class="dropdown-menu kanban-dropdown" style="max-height: 300px; overflow-y: auto;" role="menu">     <li class="new-kanban-board"><a href="#" onclick="return false;">{{ __("New Kanban Board") }}</a></li>    </ul>   </div>  </li>  <li class="hide list-link" data-view="Inbox">   <div class="btn-group">    <a class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" href="#" onclick="return false;">     {{ __("Email Inbox") }} <span class="caret"></span>    </a>    <ul class="dropdown-menu email-account-dropdown" style="max-height: 300px; overflow-y: auto;" role="menu">    </ul>   </div>  </li>  {% if(frappe.help.has_help(doctype)) { %}  <li><a class="help-link list-link" data-doctype="{{ doctype }}">{{ __("Help") }}</a></li>  {% } %} </ul> <ul class="list-unstyled sidebar-menu list-group-by"> </ul>  <ul class="list-unstyled sidebar-menu sidebar-stat">  <li class="list-sidebar-label stat-label">{{ __("Tags") }}</li>  <li class="list-stats list-link">   <div class="btn-group">    <a class = "dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" href="#" onclick="return false;">     {{ __("Tags") }}<span class="caret"></span>    </a>    <ul class="dropdown-menu list-stats-dropdown" role="menu">     <div class="dropdown-search">      <input type="text" placeholder="Search" class="form-control dropdown-search-input input-xs">     </div>    </ul>   </div>  </li>  <li class="list-link" style="margin-top: 10px;">   <a class="list-tag-preview hidden-xs text-muted">{{ __("Show tags") }}</a>  </li> </ul> <ul class="list-unstyled sidebar-menu charts-menu hide">  <li class="h6">{%= __("Charts") %}</li>  <li class="list-link">   <a class="toggle-charts">{%= __("Toggle Charts") %}</a>  </li>  <li class="list-link">   <a class="configure-charts hidden">{%= __("Configure Charts") %}</a>  </li> </ul> <ul class="list-unstyled sidebar-menu list-filters"></ul> <ul class="list-unstyled close-sidebar-button visible-xs visible-sm">  <li class="divider"></li>  <li class="close-sidebar">Close</li> </ul>',frappe.templates.list_sidebar_stat=' {% if(!stat.length) { %} <li class="stat-no-records text-muted">{{ __("No records tagged.") }}</li> {% } else {  for (var i=0, l=stat.length; i < l; i++) {   var stat_label = stat[i][0];   var stat_count = stat[i][1]; %} <li>  <a class="stat-link badge-hover" data-label="{{ stat_label %}" data-field="{{ field %}" href="#" onclick="return false;">   <span class="badge pull-right" style="position: relative">{{ stat_count }}</span>   <span class="stat-label">{{ __(stat_label) }}</span>  </a> </li>  {% } } %} ',frappe.provide("frappe.views"),frappe.views.ListGroupBy=class{constructor(t){$.extend(this,t),this.make_wrapper(),this.user_settings=frappe.get_user_settings(this.doctype),this.group_by_fields=["assigned_to"],this.user_settings.group_by_fields&&(this.group_by_fields=this.group_by_fields.concat(this.user_settings.group_by_fields)),this.render_group_by_items(),this.make_group_by_fields_modal(),this.setup_dropdown(),this.setup_filter_by()}make_group_by_fields_modal(){var t=this,e=new frappe.ui.Dialog({title:__("Select Filters"),fields:this.get_group_by_dropdown_fields()});e.set_primary_action("Save",function(i){var s=i.group_by_fields;frappe.model.user_settings.save(t.doctype,"group_by_fields",s||null),t.group_by_fields=s?["assigned_to"].concat(s):["assigned_to"],t.render_group_by_items(),e.hide()}),this.page.sidebar.find(".add-list-group-by a ").on("click",function(){e.show()})}make_wrapper(){this.$wrapper=this.sidebar.sidebar.find(".list-group-by");var t='\n\t\t\t<li class="list-sidebar-label">\n\t\t\t\t'+__("Filter By")+'\n\t\t\t</li>\n\t\t\t<div class="list-group-by-fields">\n\t\t\t</div>\n\t\t\t<li class="add-list-group-by list-link">\n\t\t\t\t<a class="add-group-by hidden-xs text-muted">\n\t\t\t\t\t'+__("Add Fields")+' <i class="octicon octicon-plus" style="margin-left: 2px;"></i>\n\t\t\t\t</a>\n\t\t\t</li>\n\t\t';this.$wrapper.html(t)}render_group_by_items(){var t=this,e=this.group_by_fields.map(function(e){var i="assigned_to"===e?__("Assigned To"):frappe.meta.get_label(t.doctype,e);return'<li class="group-by-field list-link">\n\t\t\t\t<div class="btn-group">\n\t\t\t\t\t<a class = "dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"\n\t\t\t\t\tdata-label="'+i+'" data-fieldname="'+e+'" href="#" onclick="return false;">\n\t\t\t\t\t\t'+__(i)+'<span class="caret"></span>\n\t\t\t\t\t</a>\n\t\t\t\t\t<ul class="dropdown-menu group-by-dropdown" role="menu">\n\t\t\t\t\t\t<li><div class="list-loading text-center group-by-loading text-muted">\n\t\t\t\t\t\t\t'+__("Loading...")+"\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t</li>"}).join("");this.$wrapper.find(".list-group-by-fields").html(e)}setup_dropdown(){var t=this;this.$wrapper.on("click",".group-by-field",function(e){var i=$(e.currentTarget).find(".group-by-dropdown"),s=$(e.currentTarget).find("a").attr("data-fieldname");t.get_group_by_count(s).then(function(e){e.length?(t.render_dropdown_items(e,i),t.sidebar.setup_dropdown_search(i,".group-by-value")):i.find(".group-by-loading").hide()})})}get_group_by_dropdown_fields(){var t=this,e=[],i=this.list_view.meta.fields.filter(function(t){return["Select","Link"].includes(t.fieldtype)});return e.push({label:__(this.doctype),fieldname:"group_by_fields",fieldtype:"MultiCheck",columns:2,options:i.map(function(e){return{label:__(e.label),value:e.fieldname,checked:t.group_by_fields.includes(e.fieldname)}})}),e}get_group_by_count(t){var e=this.list_view.get_filters_for_args();e=e.filter(function(e){return!e.includes("assigned_to"===t?"_assign":t)});var i={doctype:this.doctype,current_filters:e,field:t};return frappe.call("frappe.desk.listview.get_group_by_count",i).then(function(t){var e=t.message||[],i=(e=e.filter(function(t){return 0!==t.count})).find(function(t){return t.name===frappe.session.user});return e=e.filter(function(t){return!["Guest","Administrator",frappe.session.user].includes(t.name)}),i&&e.unshift(i),e})}render_dropdown_items(t,e){var i='\n\t\t\t<div class="dropdown-search">\n\t\t\t\t<input type="text" placeholder="'+__("Search")+'" class="form-control dropdown-search-input input-xs">\n\t\t\t</div>\n\t\t'+t.map(function(t){var e=null==t.name?__("Not Specified"):t.name;return e===frappe.session.user&&(e=__("Me")),'<li class="group-by-item" data-value="'+(null==t.name?"":encodeURIComponent(t.name))+'">\n\t\t\t\t<a class="badge-hover" href="#" onclick="return false;">\n\t\t\t\t\t<span class="group-by-value" data-name="'+t.name+'">'+e+'</span>\n\t\t\t\t\t<span class="badge pull-right group-by-count">'+t.count+"</span>\n\t\t\t\t</a>\n\t\t\t</li>"}).join("");e.html(i)}setup_filter_by(){var t=this;this.$wrapper.on("click",".group-by-item",function(e){var i=$(e.currentTarget),s=i.parents(".group-by-field").find("a").data("fieldname"),a=decodeURIComponent(i.data("value").trim());return s="assigned_to"===s?"_assign":s,t.list_view.filter_area.remove(s).then(function(){var e="=";return""===a&&(e="is",a="not set"),"_assign"===s&&(e="like",a="%"+a+"%"),t.list_view.filter_area.add(t.doctype,s,e,a)})})}},frappe.templates.list_view_permission_restrictions='<table class="table table-bordered" style="margin: 0;">  <thead>   <th>{{ __("Field") }}</th>   <th>{{ __("Value") }}</th>  </thead>  <tbody>   {% for (let condition of condition_list ) { %}    {% for (let key in condition) { %}    <tr>     <td>{{ __(key) }}</td>     <td>{{ frappe.utils.comma_or(condition[key]) }}</td>    </tr>    {% } %}   {% } %}  </tbody> </table> ',frappe.provide("frappe.views"),frappe.views.GanttView=class extends frappe.views.ListView{get view_name(){return"Gantt"}setup_defaults(){var t=this;return super.setup_defaults().then(function(){t.page_title=t.page_title+" "+__("Gantt"),t.calendar_settings=frappe.views.calendar[t.doctype]||{},t.calendar_settings.order_by?(t.sort_by=t.calendar_settings.order_by,t.sort_order="asc"):(t.sort_by=t.view_user_settings.sort_by||t.calendar_settings.field_map.start,t.sort_order=t.view_user_settings.sort_order||"asc")})}setup_view(){}prepare_data(t){super.prepare_data(t),this.prepare_tasks()}prepare_tasks(){var t=this,e=this.meta,i=this.calendar_settings.field_map;this.tasks=this.data.map(function(s){var a,n=0;i.progress&&$.isFunction(i.progress)?n=i.progress(s):i.progress&&(n=s[i.progress]),a=e.title_field?$.format("{0} ({1})",[s[e.title_field],s.name]):s[i.title];var r={start:s[i.start],end:s[i.end],name:a,id:s[i.id||"name"],doctype:t.doctype,progress:n,dependencies:s.depends_on_tasks||""};return s.color&&frappe.ui.color.validate_hex(s.color)&&(r.custom_class="color-"+s.color.substr(1)),s.is_milestone&&(r.custom_class="bar-milestone"),r})}render(){var t=this;this.load_lib.then(function(){t.render_gantt()})}render_gantt(){var t=this,e=this.view_user_settings.gantt_view_mode||"Day",i=this.calendar_settings.field_map;this.$result.empty(),this.gantt=new Gantt(this.$result[0],this.tasks,{view_mode:e,date_format:"YYYY-MM-DD",on_click:function(t){frappe.set_route("Form",t.doctype,t.id)},on_date_change:function(e,s,a){var n;t.can_write&&frappe.db.set_value(e.doctype,e.id,((n={})[i.start]=moment(s).format("YYYY-MM-DD"),n[i.end]=moment(a).format("YYYY-MM-DD"),n))},on_progress_change:function(e,s){var a;if(t.can_write){var n="progress";$.isFunction(i.progress)?n=null:i.progress&&(n=i.progress),n&&frappe.db.set_value(e.doctype,e.id,((a={})[n]=parseInt(s),a))}},on_view_change:function(e){t.save_view_user_settings({gantt_view_mode:e})},custom_popup_html:function(e){var i=t.get_item(e.id),s="<h5>"+e.name+"</h5>\n\t\t\t\t\t<p>"+moment(e._start).format("MMM D")+" - "+moment(e._end).format("MMM D")+"</p>",a=t.settings.gantt_custom_popup_html;a&&$.isFunction(a)&&(s=a(e,i));return'<div class="details-container">'+s+"</div>"}}),this.setup_view_mode_buttons(),this.set_colors()}setup_view_mode_buttons(){var t=this;if(!(this.$paging_area.find(".gantt-view-mode").length>0)){var e=this.gantt.options.view_modes||[],i='<div class="btn-group gantt-view-mode">\n\t\t\t\t'+e.map(function(e){return'<button type="button"\n\t\t\t\t\t\tclass="btn btn-default btn-sm btn-view-mode '+(i=e,t.gantt.view_is(i)?"btn-info":"")+'"\n\t\t\t\t\t\tdata-value="'+e+'">\n\t\t\t\t\t\t'+__(e)+"\n\t\t\t\t\t</button>";var i}).join("")+"\n\t\t\t</div>";this.$paging_area.find(".level-left").append(i);this.$paging_area.on("click",".btn-view-mode",function(e){var i=$(e.currentTarget);t.$paging_area.find(".btn-view-mode").removeClass("btn-info"),i.addClass("btn-info"),function(e){setTimeout(function(){return t.gantt.change_view_mode(e)},0)}(i.data().value)})}}set_colors(){var t=this.tasks.map(function(t){return t.custom_class}).filter(function(t){return t&&t.startsWith("color-")}).map(function(t){var e=t.replace("#",""),i="#"+t.substr(6);return"\n\t\t\t\t.gantt .bar-wrapper."+e+" .bar {\n\t\t\t\t\tfill: "+i+";\n\t\t\t\t}\n\t\t\t\t.gantt .bar-wrapper."+e+" .bar-progress {\n\t\t\t\t\tfill: "+frappe.ui.color.get_contrast_color(i)+";\n\t\t\t\t}\n\t\t\t"}).join("");t="<style>"+t+"</style>",this.$result.prepend(t)}get_item(t){return this.data.find(function(e){return e.name===t})}get required_libs(){return["assets/frappe/js/lib/frappe-gantt/frappe-gantt.css","assets/frappe/js/lib/frappe-gantt/frappe-gantt.min.js"]}},frappe.provide("frappe.views.calendar"),frappe.provide("frappe.views.calendars"),frappe.views.CalendarView=class extends frappe.views.ListView{static load_last_view(){var t=frappe.get_route();if(3===t.length){var e=t[1],i=frappe.get_user_settings(e).Calendar||{};return t.push(i.last_calendar||"Default"),frappe.set_route(t),!0}return!1}toggle_result_area(){}get view_name(){return"Calendar"}setup_defaults(){var t=this;return super.setup_defaults().then(function(){t.page_title=__("{0} Calendar",[t.page_title]),t.calendar_settings=frappe.views.calendar[t.doctype]||{},t.calendar_name=frappe.get_route()[3]})}setup_view(){}before_render(){super.before_render(),this.save_view_user_settings({last_calendar:this.calendar_name})}render(){var t=this;this.calendar?this.calendar.refresh():this.load_lib.then(function(){return t.get_calendar_preferences()}).then(function(e){t.calendar=new frappe.views.Calendar(e)})}get_calendar_preferences(){var t=this,e={doctype:this.doctype,parent:this.$result,page:this.page,list_view:this},i=this.calendar_name;return new Promise(function(s){"Default"===i?(Object.assign(e,frappe.views.calendar[t.doctype]),s(e)):frappe.model.with_doc("Calendar View",i,function(){var t=frappe.get_doc("Calendar View",i);Object.assign(e,{field_map:{id:"name",start:t.start_date_field,end:t.end_date_field,title:t.subject_field}}),s(e)})})}get required_libs(){return["assets/frappe/js/lib/fullcalendar/fullcalendar.min.css","assets/frappe/js/lib/fullcalendar/fullcalendar.min.js","assets/frappe/js/lib/fullcalendar/locale-all.js"]}},frappe.views.Calendar=Class.extend({init:function(t){$.extend(this,t),this.get_default_options()},get_default_options:function(){var t=this;return new Promise(function(t){var e=localStorage.getItem("cal_defaultView"),i=localStorage.getItem("cal_weekends");t({defaultView:e||"month",weekends:i||!0})}).then(function(e){t.make_page(),t.setup_options(e),t.make(),t.setup_view_mode_button(e),t.bind()})},make_page:function(){var t=this;t.page.clear_user_actions(),$.each(frappe.boot.calendars,function(e,i){frappe.model.can_read(i)&&t.page.add_menu_item(__(i),function(){frappe.set_route("List",i,"Calendar")})}),$(this.parent).on("show",function(){t.$cal.fullCalendar("refetchEvents")})},make:function(){this.$wrapper=this.parent,this.$cal=$("<div>").appendTo(this.$wrapper),this.footnote_area=frappe.utils.set_footnote(this.footnote_area,this.$wrapper,__("Select or drag across time slots to create a new event.")),this.footnote_area.css({"border-top":"0px"}),this.$cal.fullCalendar(this.cal_options),this.set_css()},setup_view_mode_button:function(t){$(this.footnote_area).find(".btn-weekend").detach();var e='<button class="btn btn-default btn-xs btn-weekend">'+(t.weekends?__("Hide Weekends"):__("Show Weekends"))+"</button>";this.footnote_area.append(e)},set_localStorage_option:function(t,e){localStorage.removeItem(t),localStorage.setItem(t,e)},bind:function(){var t=this;t.$wrapper.find(".fc-button-group").on("click",".btn",function(){var e=$(this).hasClass("fc-agendaWeek-button")?"agendaWeek":$(this).hasClass("fc-agendaDay-button")?"agendaDay":"month";t.set_localStorage_option("cal_defaultView",e)}),t.$wrapper.on("click",".btn-weekend",function(){t.cal_options.weekends=!t.cal_options.weekends,t.$cal.fullCalendar("option","weekends",t.cal_options.weekends),t.set_localStorage_option("cal_weekends",t.cal_options.weekends),t.set_css(),t.setup_view_mode_button(t.cal_options)})},set_css:function(){this.$wrapper.find("button.fc-state-default").removeClass("fc-state-default").addClass("btn btn-default"),this.$wrapper.find(".fc-button-group").addClass("btn-group"),this.$wrapper.find(".fc-prev-button span").attr("class","").addClass("fa fa-chevron-left"),this.$wrapper.find(".fc-next-button span").attr("class","").addClass("fa fa-chevron-right");var t=this.$wrapper.find(".fc-button-group");t.find(".fc-state-active").addClass("active"),t.find(".btn").on("click",function(){t.find(".btn").removeClass("active"),$(this).addClass("active")})},field_map:{id:"name",start:"start",end:"end",allDay:"all_day"},color_map:{danger:"red",success:"green",warning:"orange",default:"blue"},get_system_datetime:function(t){return t._offset=moment(t).tz(frappe.sys_defaults.time_zone)._offset,frappe.datetime.convert_to_system_tz(t)},setup_options:function(t){var e=this;this.cal_options={locale:frappe.boot.user.language||"en",header:{left:"title",center:"",right:"prev,today,next month,agendaWeek,agendaDay"},editable:!0,selectable:!0,selectHelper:!0,forceEventDuration:!0,defaultView:t.defaultView,weekends:t.weekends,nowIndicator:!0,events:function(t,i,s,a){return frappe.call({method:e.get_events_method||"frappe.desk.calendar.get_events",type:"GET",args:e.get_args(t,i),callback:function(t){var i=t.message||[];i=e.prepare_events(i),a(i)}})},eventRender:function(t,e){e.attr("title",t.tooltip)},eventClick:function(t){var i=t.doctype||e.doctype;frappe.model.can_read(i)&&frappe.set_route("Form",i,t.name)},eventDrop:function(t,i,s){e.update_event(t,s)},eventResize:function(t,i,s){e.update_event(t,s)},select:function(t,i,s,a){if("month"!==a.name||i-t!=864e5){var n=frappe.model.get_new_doc(e.doctype);if(n[e.field_map.start]=e.get_system_datetime(t),e.field_map.end&&(n[e.field_map.end]=e.get_system_datetime(i)),e.field_map.allDay){var r=t._ambigTime&&i._ambigTime?1:0;n[e.field_map.allDay]=r,r&&(n[e.field_map.end]=e.get_system_datetime(moment(i).subtract(1,"s")))}frappe.set_route("Form",e.doctype,n.name)}},dayClick:function(t,i,s){if("month"===s.name){var a=$("td[data-date="+t.format("YYYY-MM-DD")+"]");a.hasClass("date-clicked")&&(e.$cal.fullCalendar("changeView","agendaDay"),e.$cal.fullCalendar("gotoDate",t),e.$wrapper.find(".date-clicked").removeClass("date-clicked"),e.$wrapper.find(".fc-month-button").removeClass("active"),e.$wrapper.find(".fc-agendaDay-button").addClass("active")),e.$wrapper.find(".date-clicked").removeClass("date-clicked"),a.addClass("date-clicked")}return!1}},this.options&&$.extend(this.cal_options,this.options)},get_args:function(t,e){return{doctype:this.doctype,start:this.get_system_datetime(t),end:this.get_system_datetime(e),filters:this.list_view.filter_area.get(),field_map:this.field_map}},refresh:function(){this.$cal.fullCalendar("refetchEvents")},prepare_events:function(t){var e=this;return(t||[]).map(function(t){return t.id=t.name,t.editable=frappe.model.can_write(t.doctype||e.doctype),t.docstatus&&t.docstatus>0&&(t.editable=!1),$.each(e.field_map,function(e,i){t[e]=t[i]}),e.field_map.allDay||(t.allDay=1),t.start=frappe.datetime.convert_to_user_tz(t.start),t.end=frappe.datetime.convert_to_user_tz(t.end),!frappe.datetime.validate(t.start)&&t.end&&(t.start=frappe.datetime.add_days(t.end,-1)),t.start&&!frappe.datetime.validate(t.end)&&(t.end=frappe.datetime.add_days(t.start,1)),e.fix_end_date_for_event_render(t),e.prepare_colors(t),t})},prepare_colors:function(t){var e,i;return this.get_css_class?(i=this.color_map[this.get_css_class(t)],i=frappe.ui.color.validate_hex(i)?i:"blue",t.backgroundColor=frappe.ui.color.get(i,"extra-light"),t.textColor=frappe.ui.color.get(i,"dark")):(e=t.color,frappe.ui.color.validate_hex(e)&&e||(e=frappe.ui.color.get("blue","extra-light")),t.backgroundColor=e,t.textColor=frappe.ui.color.get_contrast_color(e)),t},update_event:function(t,e){return frappe.model.remove_from_locals(this.doctype,t.name),frappe.call({method:this.update_event_method||"frappe.desk.calendar.update_event",args:this.get_update_args(t),callback:function(t){t.exc&&(frappe.show_alert(__("Unable to update event")),e())},error:function(){e()}})},get_update_args:function(t){var e={name:t[this.field_map.id]};return e[this.field_map.start]=this.get_system_datetime(t.start),this.field_map.allDay&&(e[this.field_map.allDay]=t.start._ambigTime&&t.end._ambigTime?1:0),this.field_map.end&&(t.end||(t.end=t.start.add(1,"hour")),e[this.field_map.end]=this.get_system_datetime(t.end),e[this.field_map.allDay]&&(e[this.field_map.end]=this.get_system_datetime(moment(t.end).subtract(1,"s")))),e.doctype=t.doctype||this.doctype,{args:e,field_map:this.field_map}},fix_end_date_for_event_render:function(t){t.allDay&&(t.start=t.start?$.fullCalendar.moment(t.start).stripTime():null,t.end=t.end?$.fullCalendar.moment(t.end).add(1,"day").stripTime():null)}}),frappe.provide("frappe.views"),frappe.views.ImageView=class extends frappe.views.ListView{get view_name(){return"Image"}setup_defaults(){var t=this;return super.setup_defaults().then(function(){t.page_title=t.page_title+" "+__("Images")})}setup_view(){this.setup_columns(),this.setup_check_events()}set_fields(){this.fields=["name"].concat(this.get_fields_in_list_view().map(function(t){return t.fieldname}),[this.meta.title_field],[this.meta.image_field])}prepare_data(t){var e=this;super.prepare_data(t),this.items=this.data.map(function(t){return t._image_url=e.get_image_url(t),t})}render(){var t=this;this.get_attached_images().then(function(){t.render_image_view(),t.gallery?t.gallery.prepare_pswp_items(t.items,t.images_map):t.setup_gallery()})}render_image_view(){var t=this.items.map(this.item_html.bind(this)).join("");this.$result.html("\n\t\t\t"+this.get_header_html()+'\n\t\t\t<div class="image-view-container small">\n\t\t\t\t'+t+"\n\t\t\t</div>\n\t\t")}item_details_html(t){var e=this.get_fields_in_list_view().map(function(t){return t.fieldname})||[],i='<div><ul class="list-unstyled image-view-info">';return e.forEach(function(e,s){t[e]&&(i+=0==s?"<li>"+t[e]+"</li>":'<li class="text-muted">'+t[e]+"</li>")}),i+="</ul></div>"}item_html(t){t._name=encodeURI(t.name);var e=t._name,i=strip_html(t[this.meta.title_field||"name"]),s=t._image_url?"":"no-image",a=t._image_url?'<img data-name="'+e+'" src="'+t._image_url+'" alt="'+i+'">':'<span class="placeholder-text">\n\t\t\t\t'+frappe.get_abbr(i)+"\n\t\t\t</span>",n=this.item_details_html(t);return'\n\t\t\t<div class="image-view-item">\n\t\t\t\t<div class="image-view-header">\n\t\t\t\t\t<div class="list-row-col list-subject ellipsis level">\n\t\t\t\t\t\t'+this.get_subject_html(t)+'\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="image-view-body">\n\t\t\t\t\t<a  data-name="'+e+'"\n\t\t\t\t\t\ttitle="'+e+'"\n\t\t\t\t\t\thref="'+this.get_form_link(t)+'"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="image-field '+s+'"\n\t\t\t\t\t\t\tdata-name="'+e+'"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t'+a+'\n\t\t\t\t\t\t\t<button class="btn btn-default zoom-view" data-name="'+e+'">\n\t\t\t\t\t\t\t\t<i class="fa fa-search-plus"></i>\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t\t'+n+"\n\t\t\t</div>\n\t\t"}get_image_url(t){var e;return e=t.image?t.image:t[this.meta.image_field],window.cordova&&!frappe.utils.is_url(e)&&(e=frappe.base_url+e),e||null}get_attached_images(){var t=this;return frappe.call({method:"frappe.core.doctype.file.file.get_attached_images",args:{doctype:this.doctype,names:this.items.map(function(t){return t.name})}}).then(function(e){t.images_map=Object.assign(t.images_map||{},e.message)})}get_header_html(){return this.get_header_html_skeleton('\n\t\t\t<div class="list-row-col list-subject level ">\n\t\t\t\t<input class="level-item list-check-all hidden-xs" type="checkbox" title="Select All">\n\t\t\t\t<span class="level-item list-liked-by-me">\n\t\t\t\t\t<i class="octicon octicon-heart text-extra-muted" title="Likes"></i>\n\t\t\t\t</span>\n\t\t\t\t<span class="level-item"></span>\n\t\t\t</div>\n\t\t')}setup_gallery(){var t=this;this.gallery=new frappe.views.GalleryView({doctype:this.doctype,items:this.items,wrapper:this.$result,images_map:this.images_map}),this.$result.on("click",".btn.zoom-view",function(e){e.preventDefault(),e.stopPropagation();var i=$(this).data().name;return i=decodeURIComponent(i),t.gallery.show(i),!1})}},frappe.views.GalleryView=Class.extend({init:function(t){$.extend(this,t);var e=this;this.lib_ready=this.load_lib(),this.lib_ready.then(function(){e.prepare()})},prepare:function(){if(this.pswp_root=$("body > .pswp"),0===this.pswp_root.length){var t=frappe.render_template("photoswipe_dom");this.pswp_root=$(t).appendTo("body")}},prepare_pswp_items:function(t,e){var i=this,s=this;return t&&(this.items=this.items.concat(t),this.images_map=e),new Promise(function(t){var e=i.items.map(function(t){var e,i,a='img[data-name="'+t._name+'"]',n=s.wrapper.find(a).get(0);return n&&(e=n.naturalWidth,i=n.naturalHeight),n||(e=(n=s.wrapper.find('.image-field[data-name="'+t._name+'"]').get(0)).getBoundingClientRect().width,i=n.getBoundingClientRect().height),{src:t._image_url,msrc:t._image_url,name:t.name,w:e,h:i,el:n}});i.pswp_items=e,t()})},show:function(t){var e=this;this.lib_ready.then(function(){return e.prepare_pswp_items()}).then(function(){return e._show(t)})},_show:function(t){var e=this,i=this.pswp_items,s={index:i.findIndex(function(e){return e.name===t}),getThumbBoundsFn:function(t){var s='img[data-name="'+i[t]._name+'"]',a=e.wrapper.find(s).get(0);if(a){var n=window.pageYOffset||document.documentElement.scrollTop,r=a.getBoundingClientRect();return{x:r.left,y:r.top+n,w:r.width}}},history:!1,shareEl:!1,showHideOpacity:!0};this.pswp=new PhotoSwipe(this.pswp_root.get(0),PhotoSwipeUI_Default,i,s),this.browse_images(),this.pswp.init()},browse_images:function(){var t=this,e=this.pswp_root.find(".pswp__more-items"),i=this.images_map,s=null;function a(){clearTimeout(s),e.show(),s=setTimeout(n,2e3)}function n(){e.hide()}function r(t){return'<div class="pswp__more-item">\n\t\t\t\t<img src="'+t+'">\n\t\t\t</div>'}this.pswp.listen("afterChange",function(){var t=i[this.currItem.name];if(t&&1!==t.length){a();var s=t.map(r).join("");e.html(s)}else e.html("")}),this.pswp.listen("beforeChange",n),this.pswp.listen("initialZoomOut",n),this.pswp.listen("destroy",function(){$(document).off("mousemove",a)}),e.on("click",".pswp__more-item",function(e){var i=e.target,s=t.pswp.items.findIndex(function(e){return e.name===t.pswp.currItem.name});t.pswp.goTo(s),t.pswp.items.splice(s,1,{src:i.src,w:i.naturalWidth,h:i.naturalHeight,name:t.pswp.currItem.name}),t.pswp.invalidateCurrItems(),t.pswp.updateSize(!0)}),$(document).on("mousemove",a)},load_lib:function(){return new Promise(function(t){var e="assets/frappe/js/lib/photoswipe/";frappe.require([e+"photoswipe.css",e+"default-skin.css",e+"photoswipe.js",e+"photoswipe-ui-default.js"],t)})}}),frappe.provide("frappe.views"),frappe.views.KanbanView=class extends frappe.views.ListView{static load_last_view(){var t=frappe.get_route();if(3===t.length){var e=t[1],i=frappe.get_user_settings(e).Kanban||{};return i.last_kanban_board?(t.push(i.last_kanban_board),frappe.set_route(t),!0):(frappe.msgprint({title:__("Error"),indicator:"red",message:__("Missing parameter Kanban Board Name")}),frappe.set_route("List",e,"List"),!0)}return!1}get view_name(){return"Kanban"}setup_defaults(){var t=this;return super.setup_defaults().then(function(){return t.board_name=frappe.get_route()[3],t.page_title=t.board_name,t.card_meta=t.get_card_meta(),t.menu_items.push({label:__("Save filters"),action:function(){t.save_kanban_board_filters()}}),t.get_board()})}get_board(){var t=this;return frappe.db.get_doc("Kanban Board",this.board_name).then(function(e){t.board=e,t.board.filters_array=JSON.parse(t.board.filters||"[]"),t.filters=t.board.filters_array})}before_refresh(){}setup_view(){this.setup_realtime_updates()}set_fields(){super.set_fields(),this._add_field(this.card_meta.title_field)}before_render(){frappe.model.user_settings.save(this.doctype,"last_view",this.view_name),this.save_view_user_settings({last_kanban_board:this.board_name})}on_filter_change(){JSON.stringify(this.board.filters_array)!==JSON.stringify(this.filter_area.get())?this.page.set_indicator(__("Not Saved"),"orange"):this.page.clear_indicator()}save_kanban_board_filters(){var t=this,e=this.filter_area.get();frappe.call({method:"frappe.desk.doctype.kanban_board.kanban_board.save_filters",args:{board_name:this.board_name,filters:e}}).then(function(i){i.exc?frappe.show_alert({indicator:"red",message:__("There was an error saving filters")}):(frappe.show_alert({indicator:"green",message:__("Filters saved")}),t.board.filters_array=e,t.on_filter_change())})}render(){var t=this.board_name;this.kanban&&t===this.kanban.board_name?this.kanban.update(this.data):this.kanban=new frappe.views.KanbanBoard({doctype:this.doctype,board:this.board,board_name:t,cards:this.data,card_meta:this.card_meta,wrapper:this.$result,cur_list:this,user_settings:this.view_user_settings})}get_card_meta(){var t=frappe.get_meta(this.doctype),e=frappe.model.get_new_doc(this.doctype),i=null,s=!1;this.meta.title_field&&(i=frappe.meta.get_field(this.doctype,this.meta.title_field)),this.meta.fields.forEach(function(t){in_list(["Data","Text","Small Text","Text Editor"],t.fieldtype)&&!t.hidden&&!i&&(i=t)});var a=t.fields.filter(function(t){return t.reqd&&!e[t.fieldname]});return(a.some(function(t){return frappe.model.table_fields.includes(t.fieldtype)})||a.length>1)&&(s=!0),i||(i=frappe.meta.get_field(this.doctype,"name")),{quick_entry:s,title_field:i}}get required_libs(){return["assets/frappe/js/lib/fluxify.min.js","assets/frappe/js/frappe/views/kanban/kanban_board.js"]}},frappe.views.KanbanView.setup_dropdown_in_sidebar=function(t,e){frappe.call("frappe.desk.doctype.kanban_board.kanban_board.get_kanban_boards",{doctype:t}).then(function(t){return t.message}).then(function(t){t&&($('<li role="separator" class="divider"></li>').appendTo(e),t.forEach(function(t){var i=["List",t.reference_doctype,"Kanban",t.name].join("/");$('<li>\n\t\t\t\t\t<a href="#'+i+'">\n\t\t\t\t\t\t<span>'+__(t.name)+"</span>\n\t\t\t\t\t"+(t.private?'<i class="fa fa-lock fa-fw text-warning"></i>':"")+"\n\t\t\t\t\t</a>\n\t\t\t\t</li>\n\t\t\t\t").appendTo(e)}))}),e.on("click",".new-kanban-board",function(){s().show()});var i=null;function s(){if(i)return i;var e=function(){var e=[{fieldtype:"Data",fieldname:"board_name",label:__("Kanban Board Name"),reqd:1,description:["Note","ToDo"].includes(t)?__("This Kanban Board will be private"):""}];"Task"===t&&e.push({fieldtype:"Link",fieldname:"project",label:__("Project"),options:"Project"});var i=frappe.get_meta(t).fields.filter(function(t){return"Select"===t.fieldtype&&"kanban_column"!==t.fieldname});i.length>0?e.push({fieldtype:"Select",fieldname:"field_name",label:__("Columns based on"),options:i.map(function(t){return{label:t.label,value:t.fieldname}}),default:i[0],reqd:1}):e=[{fieldtype:"HTML",options:'\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<p class="text-medium">\n\t\t\t\t\t\t'+__('No fields found that can be used as a Kanban Column. Use the Customize Form to add a Custom Field of type "Select".')+'\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<a class="btn btn-xs btn-default" href="#Form/Customize Form?doc_type='+t+'">\n\t\t\t\t\t\t\t'+__("Customize Form")+"\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t"}];return e}(),s=e.length>1?__("Save"):"",a=e.length>1?function(e){(function(e,i,s){return frappe.call({method:"frappe.desk.doctype.kanban_board.kanban_board.quick_kanban_board",args:{doctype:t,board_name:e,field_name:i,project:s},callback:function(e){var i=e.message;i.filters&&(frappe.provide("frappe.kanban_filters"),frappe.kanban_filters[i.kanban_board_name]=i.filters),frappe.set_route("List",t,"Kanban",i.kanban_board_name)}})})(e.board_name,e.field_name,e.project).then(function(){return i.hide()},function(t){return frappe.msgprint(t)})}:null;return i=new frappe.ui.Dialog({title:__("New Kanban Board"),fields:e,primary_action_label:s,primary_action:a})}},frappe.provide("frappe.views"),frappe.views.InboxView=class extends frappe.views.ListView{static load_last_view(){var t,e=frappe.get_route();return!e[3]&&frappe.boot.email_accounts.length?(t="All Accounts"==frappe.boot.email_accounts[0].email_id?"All Accounts":frappe.boot.email_accounts[0].email_account,frappe.set_route("List","Communication","Inbox",t),!0):(!e[3]||"All Accounts"!==e[3]&&!function(t){return frappe.boot.email_accounts.find(function(e){return e.email_account===t})}(e[3]))&&(frappe.msgprint(__("Invalid Email Account")),window.history.back(),!0)}get view_name(){return"Inbox"}show(){super.show(),this.save_view_user_settings({last_email_account:this.current_email_account})}setup_defaults(){super.setup_defaults(),this.email_account=frappe.get_route()[3],this.page_title=this.email_account,this.filters=this.get_inbox_filters()}get is_sent_emails(){var t=this.filter_area.get().find(function(t){return"sent_or_received"===t[1]});return t&&"Sent"===t[3]}render(){this.emails=this.data,this.render_inbox_view()}render_inbox_view(){var t=this.emails.map(this.render_email_row.bind(this)).join("");this.$result.html("\n\t\t\t"+this.get_header_html()+"\n\t\t\t"+t+"\n\t\t")}get_header_html(){return this.get_header_html_skeleton('\n\t\t\t<div class="list-row-col list-subject level">\n\t\t\t\t<input class="level-item list-check-all hidden-xs" type="checkbox" title="Select All">\n\t\t\t\t<span class="level-item">'+__("Subject")+'</span>\n\t\t\t</div>\n\t\t\t<div class="list-row-col hidden-xs">\n\t\t\t\t<span>'+(this.is_sent_emails?__("To"):__("From"))+"</span>\n\t\t\t</div>\n\t\t")}render_email_row(t){!t.css_seen&&t.seen&&(t.css_seen="seen");var e='\n\t\t\t<div class="list-row-col list-subject level ellipsis">\n\t\t\t\t<input class="level-item list-row-checkbox hidden-xs" type="checkbox" data-name="'+t.name+'">\n\t\t\t\t<span class="level-item">\n\t\t\t\t\t<a class="'+(t.seen?"":"bold")+' ellipsis" href="'+this.get_form_link(t)+'">\n\t\t\t\t\t\t'+t.subject+'\n\t\t\t\t\t</a>\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t\t<div class="list-row-col hidden-xs">\n\t\t\t\t<span>'+(this.is_sent_emails?t.recipients:t.sender)+"</span>\n\t\t\t</div>\n\t\t";return this.get_list_row_html_skeleton(e,this.get_meta_html(t))}get_meta_html(t){var e=t.has_attachment?'<span class="fa fa-paperclip fa-large" title="'+__("Has Attachments")+'"></span>':"",i=frappe.utils.get_form_link(t.reference_doctype,t.reference_name);return'\n\t\t\t<div class="level-item hidden-xs list-row-activity">\n\t\t\t\t'+(t.reference_doctype&&t.reference_doctype!==this.doctype?'<a class="text-muted grey" href="'+i+'"\n\t\t\t\ttitle="'+__("Linked with {0}",[t.reference_doctype])+'">\n\t\t\t\t<i class="fa fa-link fa-large"></i>\n\t\t\t</a>':"")+"\n\t\t\t\t"+e+"\n\t\t\t\t"+comment_when(t.modified,!0)+"\n\t\t\t</div>\n\t\t"}get_inbox_filters(){var t=this.email_account,e=[["Communication","communication_type","=","Communication",!0],["Communication","communication_medium","=","Email",!0]],i=[];if("Sent"===t)i=e.concat([["Communication","sent_or_received","=","Sent",!0],["Communication","email_status","not in","Spam,Trash",!0]]);else if(in_list(["Spam","Trash"],t))i=e.concat([["Communication","email_status","=",t,!0],["Communication","email_account","in",frappe.boot.all_accounts,!0]]);else{var s="=";"All Accounts"==t&&(s="in",t=frappe.boot.all_accounts),i=e.concat([["Communication","sent_or_received","=","Received",!0],["Communication","email_account",s,t,!0],["Communication","email_status","not in","Spam,Trash",!0]])}return i}get_no_result_message(){var t,e=this.email_account;return in_list(["Spam","Trash"],e)?__("No {0} mail",[e]):(t=e||frappe.boot.email_accounts.length?{doctype:"Communication",msg:__("No Emails"),label:__("Compose Email")}:{doctype:"Email Account",msg:__("No Email Account"),label:__("New Email Account")},'\n\t\t\t<div class="msg-box no-border">\n\t\t\t\t'+(frappe.model.can_create(t.doctype)?"<p>"+t.msg+'</p>\n\t\t\t<p>\n\t\t\t\t<button class="btn btn-primary btn-sm btn-new-doc">\n\t\t\t\t\t'+t.label+"\n\t\t\t\t</button>\n\t\t\t</p>\n\t\t\t":"<p>"+__("No Email Accounts Assigned")+"</p>")+"\n\t\t\t</div>\n\t\t")}make_new_doc(){this.email_account||frappe.boot.email_accounts.length?new frappe.views.CommunicationComposer({doc:{}}):(frappe.route_options={email_id:frappe.session.user_email},frappe.new_doc("Email Account"))}},frappe.provide("frappe.views"),frappe.views.FileView=class extends frappe.views.ListView{static load_last_view(){if(2===frappe.get_route().length){var t=frappe.get_user_settings("File","File");return frappe.set_route("List","File",t.last_folder||frappe.boot.home_folder),!0}return redirect_to_home_if_invalid_route()}get view_name(){return"File"}show(){redirect_to_home_if_invalid_route()||super.show()}setup_view(){this.render_header(),this.setup_events()}set_breadcrumbs(){var t=frappe.get_route();t.splice(-1),"File"!==t[t.length-1]&&frappe.breadcrumbs.add({type:"Custom",label:__("Home"),route:"#List/File/Home"})}setup_defaults(){var t=this;return super.setup_defaults().then(function(){t.page_title=__("File Manager");var e=frappe.get_route();t.current_folder=e.slice(2).join("/"),t.filters=[["File","folder","=",t.current_folder,!0]],t.order_by=t.view_user_settings.order_by||"file_name asc",t.menu_items=t.menu_items.concat(t.file_menu_items())})}file_menu_items(){var t=this;return[{label:__("Home"),action:function(){frappe.set_route("List","File","Home")}},{label:__("Cut"),action:function(){frappe.file_manager.cut(t.get_checked_items(),t.current_folder)},class:"cut-menu-button hide"},{label:__("Paste"),action:function(){frappe.file_manager.paste(t.current_folder)},class:"paste-menu-button hide"},{label:__("New Folder"),action:function(){frappe.prompt(__("Name"),function(e){e.value.indexOf("/")>-1&&frappe.throw(__("Folder name should not include '/' (slash)"));var i={file_name:e.value,folder:t.current_folder};frappe.call({method:"frappe.core.doctype.file.file.create_new_folder",args:i})},__("Enter folder name"),__("Create"))}},{label:__("Toggle Grid View"),action:function(){frappe.views.FileView.grid_view=!frappe.views.FileView.grid_view,t.refresh()}},{label:__("Import Zip"),action:function(){new frappe.ui.FileUploader({folder:t.current_folder,restrictions:{allowed_file_types:[".zip"]},on_success:function(t){frappe.show_alert(__("Unzipping files...")),frappe.call("frappe.core.doctype.file.file.unzip_file",{name:t.name}).then(function(t){t.message&&frappe.show_alert(__("Unzipped {0} files",[t.message]))})}})}}]}set_fields(){this.fields=this.meta.fields.filter(function(t){return frappe.model.is_value_type(t.fieldtype)&&!t.hidden}).map(function(t){return t.fieldname}).concat(["name","modified","creation"])}prepare_data(t){var e=this;super.prepare_data(t),this.data=this.data.map(function(t){return e.prepare_datum(t)}),"file_name"===this.sort_selector.sort_by&&this.data.sort(function(t,e){return t.is_folder&&!e.is_folder?-1:!t.is_folder&&e.is_folder?1:0})}prepare_datum(t){var e="";e=t.is_folder?"octicon octicon-file-directory":frappe.utils.is_image_file(t.file_name)?"octicon octicon-file-media":"octicon octicon-file-text";var i=t.file_name||t.file_url;return i=i.slice(0,60),t._title=i,t.icon_class=e,t.subject_html='\n\t\t\t<i class="'+e+' text-muted" style="width: 16px;"></i>\n\t\t\t<span>'+i+"</span>\n\t\t\t"+(t.is_private?'<i class="fa fa-lock fa-fw text-warning"></i>':"")+"\n\t\t",t}before_render(){super.before_render(),frappe.model.user_settings.save("File","grid_view",frappe.views.FileView.grid_view),this.save_view_user_settings({last_folder:this.current_folder})}render(){this.$result.removeClass("file-grid"),frappe.views.FileView.grid_view?this.render_grid_view():super.render()}render_grid_view(){var t,e=this;t=this.data.map(function(t){return'\n\t\t\t\t<a href="'+e.get_route_url(t)+'">\n\t\t\t\t\t<div class="file-wrapper padding flex small">\n\t\t\t\t\t\t<div class="file-icon text-muted">\n\t\t\t\t\t\t\t<span class="'+t.icon_class+' mega-octicon"></span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="file-title ellipsis">'+t._title+"</div>\n\t\t\t\t\t</div>\n\t\t\t\t</a>\n\t\t\t"}).join(""),this.$result.addClass("file-grid"),this.$result.html(t)}get_breadcrumbs_html(){var t=frappe.get_route().slice(2);return t.map(function(e,i){return i===t.length-1?"<span>"+e+"</span>":'<a href="'+t.reduce(function(t,e,s){return s<=i&&(t+="/"+e),t},"#List/File")+'">'+e+"</a>"}).slice(-3).join("&nbsp;/&nbsp;")}get_header_html(){var t=this.get_breadcrumbs_html(),e='\n\t\t\t<div class="list-row-col list-subject level">\n\t\t\t\t<input class="level-item list-check-all hidden-xs" type="checkbox" title="'+__("Select All")+'">\n\t\t\t\t<span class="level-item">'+t+'</span>\n\t\t\t</div>\n\t\t\t<div class="list-row-col ellipsis hidden-xs">\n\t\t\t\t<span>'+__("Size")+'</span>\n\t\t\t</div>\n\t\t\t<div class="list-row-col ellipsis hidden-xs">\n\t\t\t\t<span>'+__("Created")+"</span>\n\t\t\t</div>\n\t\t";return this.get_header_html_skeleton(e,'<span class="list-count"></span>')}get_route_url(t){return t.is_folder?"#List/File/"+t.name:this.get_form_link(t)}get_left_html(t){t=this.prepare_datum(t);var e,i=frappe.form.formatters.FileSize(t.file_size),s=this.get_route_url(t),a=t.creation.split(" ")[0];return e=a===frappe.datetime.now_date()?comment_when(t.creation):frappe.datetime.str_to_user(a),'\n\t\t\t<div class="list-row-col ellipsis list-subject level">\n\t\t\t\t<input class="level-item list-row-checkbox hidden-xs" type="checkbox" data-name="'+t.name+'">\n\t\t\t\t<span class="level-item  ellipsis" title="'+t.file_name+'">\n\t\t\t\t\t<a class="ellipsis" href="'+s+'" title="'+t.file_name+'">\n\t\t\t\t\t\t'+t.subject_html+'\n\t\t\t\t\t</a>\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t\t<div class="list-row-col ellipsis hidden-xs text-muted">\n\t\t\t\t<span>'+i+'</span>\n\t\t\t</div>\n\t\t\t<div class="list-row-col ellipsis hidden-xs text-muted">\n\t\t\t\t<span>'+e+"</span>\n\t\t\t</div>\n\t\t"}get_right_html(t){return'\n\t\t\t<div class="level-item list-row-activity">\n\t\t\t\t'+comment_when(t.modified)+"\n\t\t\t</div>\n\t\t"}setup_events(){super.setup_events(),this.setup_drag_drop()}setup_drag_drop(){var t=this;this.$result.on("dragenter dragover",!1).on("drop",function(e){var i=e.originalEvent.dataTransfer;i&&i.files&&i.files.length>0&&(e.stopPropagation(),e.preventDefault(),new frappe.ui.FileUploader({files:i.files,folder:t.current_folder}))})}toggle_result_area(){super.toggle_result_area(),this.toggle_cut_paste_buttons()}on_row_checked(){super.on_row_checked(),this.toggle_cut_paste_buttons()}toggle_cut_paste_buttons(){var t=this.page.menu_btn_group.find(".paste-menu-button");!frappe.file_manager.can_paste||frappe.file_manager.old_folder===this.current_folder?t.addClass("hide"):t.removeClass("hide");var e=this.page.menu_btn_group.find(".cut-menu-button");this.$checks&&this.$checks.length>0?e.removeClass("hide"):e.addClass("hide")}},frappe.views.FileView.grid_view=frappe.get_user_settings("File").grid_view||!1,frappe.provide("frappe.treeview_settings"),frappe.provide("frappe.views.trees"),window.cur_tree=null,frappe.views.TreeFactory=class extends frappe.views.Factory{make(t){frappe.model.with_doctype(t[1],function(){var e={doctype:t[1],meta:frappe.get_meta(t[1])};if(!frappe.treeview_settings[t[1]]&&!frappe.meta.get_docfield(t[1],"is_group"))return frappe.msgprint(__("Tree view not available for {0}",[t[1]])),!1;$.extend(e,frappe.treeview_settings[t[1]]||{}),frappe.views.trees[e.doctype]=new frappe.views.TreeView(e)})}},frappe.views.TreeView=Class.extend({init:function(t){this.opts={},this.opts.get_tree_root=!0,this.opts.show_expand_all=!0,$.extend(this.opts,t),this.doctype=t.doctype,this.args={doctype:this.doctype},this.page_name=frappe.get_route_str(),this.get_tree_nodes=this.opts.get_tree_nodes||"frappe.desk.treeview.get_children",this.get_permissions(),this.make_page(),this.make_filters(),this.opts.get_tree_root&&this.get_root(),this.onload(),this.set_menu_item(),this.set_primary_action()},get_permissions:function(){this.can_read=frappe.model.can_read(this.doctype),this.can_create=-1!==frappe.boot.user.can_create.indexOf(this.doctype)||-1!==frappe.boot.user.in_create.indexOf(this.doctype),this.can_write=frappe.model.can_write(this.doctype),this.can_delete=frappe.model.can_delete(this.doctype)},make_page:function(){var t=this;if(this.parent=frappe.container.add_page(this.page_name),frappe.ui.make_app_page({parent:this.parent,single_column:!0}),this.page=this.parent.page,frappe.container.change_to(this.page_name),frappe.breadcrumbs.add(t.opts.breadcrumb||locals.DocType[t.doctype].module,t.doctype),this.set_title(),this.page.main.css({"min-height":"300px","padding-bottom":"25px"}),this.opts.show_expand_all&&this.page.add_inner_button(__("Expand All"),function(){t.tree.load_children(t.tree.root_node,!0)}),this.opts.view_template){var e=$('<div class="row"><div>').appendTo(this.page.main);this.body=$('<div class="col-sm-6 col-xs-12"></div>').appendTo(e),this.node_view=$('<div class="col-sm-6 hidden-xs"></div>').appendTo(e)}else this.body=this.page.main},set_title:function(){this.page.set_title(this.opts.title||__("{0} Tree",[__(this.doctype)]))},onload:function(){this.opts.onload&&this.opts.onload(this)},make_filters:function(){var t=this;frappe.treeview_settings.filters=[],$.each(this.opts.filters||[],function(e,i){frappe.route_options&&frappe.route_options[i.fieldname]&&(i.default=frappe.route_options[i.fieldname]),i.disable_onchange||(i.change=function(){i.on_change&&i.on_change();var e=this.get_value();t.args[i.fieldname]=e,t.root_label=e||t.opts.root_label,t.set_title(),t.make_tree()}),t.page.add_field(i),i.default&&$("[data-fieldname='"+i.fieldname+"']").trigger("change")})},get_root:function(){var t=this;frappe.call({method:t.get_tree_nodes,args:t.args,callback:function(e){e.message&&(t.root_label=e.message[0].value,t.make_tree())}})},make_tree:function(){var t=this;$(this.parent).find(".tree").remove(),this.tree=new frappe.ui.Tree({parent:this.body,label:this.args[this.opts.root_label]||this.root_label||this.opts.root_label,expandable:!0,args:this.args,method:this.get_tree_nodes,toolbar:this.get_toolbar(),get_label:this.opts.get_label,on_render:this.opts.onrender,on_click:function(e){t.select_node(e)}}),cur_tree=this.tree,this.post_render()},post_render:function(){this.opts.post_render&&this.opts.post_render(this)},select_node:function(t){this.opts.click&&this.opts.click(t),this.opts.view_template&&(this.node_view.empty(),$(frappe.render_template(this.opts.view_template,{data:t.data,doctype:this.doctype})).appendTo(this.node_view))},get_toolbar:function(){var t=this,e=[{label:__(t.can_write?"Edit":"Details"),condition:function(e){return!e.is_root&&t.can_read},click:function(e){frappe.set_route("Form",t.doctype,e.label)}},{label:__("Add Child"),condition:function(e){return t.can_create&&e.expandable&&!e.hide_add},click:function(e){t.new_node()},btnClass:"hidden-xs"},{label:__("Rename"),condition:function(e){var i=!0;return t.doctype&&frappe.get_meta(t.doctype)&&(frappe.get_meta(t.doctype).allow_rename||(i=!1)),!e.is_root&&t.can_write&&i},click:function(e){frappe.model.rename_doc(t.doctype,e.label,function(t){e.$tree_link.find("a").text(t),e.label=t})},btnClass:"hidden-xs"},{label:__("Delete"),condition:function(e){return!e.is_root&&t.can_delete},click:function(e){frappe.model.delete_doc(t.doctype,e.label,function(){e.parent.remove()})},btnClass:"hidden-xs"}];return this.opts.toolbar&&this.opts.extend_toolbar?(e=e.filter(function(e){return!t.opts.toolbar.find(function(t){return t.label==e.label})})).concat(this.opts.toolbar):this.opts.toolbar&&!this.opts.extend_toolbar?this.opts.toolbar:e},new_node:function(){var t=this,e=t.tree.get_selected_node();if(e&&e.expandable){this.prepare_fields();var i=new frappe.ui.Dialog({title:__("New {0}",[__(t.doctype)]),fields:t.fields}),s=$.extend({},t.args);s["parent_"+t.doctype.toLowerCase().replace(/ /g,"_")]=t.args.parent,i.set_value("is_group",0),i.set_values(s),i.set_primary_action(__("Create New"),function(){var a=i.get_values();if(a)return a.parent=e.label,a.doctype=t.doctype,e.is_root?a.is_root=e.is_root:a.is_root=!1,i.hide(),frappe.dom.freeze(__("Creating {0}",[t.doctype])),$.extend(s,a),frappe.call({method:t.opts.add_tree_node||"frappe.desk.treeview.add_node",args:s,callback:function(i){i.exc||(e.expanded&&t.tree.toggle_node(e),t.tree.load_children(e,!0))},always:function(){frappe.dom.unfreeze()}})}),i.show()}else frappe.msgprint(__("Select a group node first."))},prepare_fields:function(){var t=this;this.fields=[{fieldtype:"Check",fieldname:"is_group",label:__("Group Node"),description:__("Further nodes can be only created under 'Group' type nodes")}],this.opts.fields&&(this.fields=this.opts.fields),this.ignore_fields=this.opts.ignore_fields||[];var e=$.map(t.opts.meta.fields,function(t){return t.reqd||t.bold&&!t.read_only?t:null}),i=this.fields.map(function(t){return t.fieldname});e.map(function(e){-1===$.inArray(e.fieldname,t.ignore_fields)&&-1===$.inArray(e.fieldname,i)&&t.fields.push(e)})},print_tree:function(){if(!frappe.model.can_print(this.doctype))return frappe.msgprint(__("You are not allowed to print this report")),!1;var t=$(".tree:visible").html(),e=this;frappe.ui.get_print_settings(!1,function(i){var s=__(e.docname||e.doctype);frappe.render_tree({title:s,tree:t,print_settings:i}),frappe.call({method:"frappe.core.doctype.access_log.access_log.make_access_log",args:{doctype:e.doctype,report_name:e.page_name,page:t,method:"Print"}})})},set_primary_action:function(){var t=this;!this.opts.disable_add_node&&this.can_create&&t.page.set_primary_action(__("New"),function(){t.new_node()},"octicon octicon-plus")},set_menu_item:function(){var me=this;this.menu_items=[{label:__("View List"),action:function(){frappe.set_route("List",me.doctype)}},{label:__("Print"),action:function(){me.print_tree()}},{label:__("Refresh"),action:function(){me.make_tree()}}],me.opts.menu_items&&me.menu_items.push.apply(me.menu_items,me.opts.menu_items),$.each(me.menu_items,function(i,menu_item){var has_perm=!0;menu_item.condition&&(has_perm=eval(menu_item.condition)),has_perm&&me.page.add_menu_item(menu_item.label,menu_item.action)})}}),frappe.provide("frappe.views"),frappe.provide("frappe.interaction_settings"),frappe.views.InteractionComposer=class{constructor(t){$.extend(this,t),this.make()}make(){var t=this;t.dialog=new frappe.ui.Dialog({title:t.title||t.subject||__("New Activity"),no_submit_on_enter:!0,fields:t.get_fields(),primary_action_label:__("Create"),primary_action:function(){t.create_action()}}),$(document).on("upload_complete",function(e,i){if(t.dialog.display){var s=$(t.dialog.fields_dict.select_attachments.wrapper),a=s.find("[data-file-name]:checked").map(function(){return $(this).attr("data-file-name")});t.render_attach(),a.push(i.name),$.each(a,function(t,e){s.find('[data-file-name="'+e+'"]').prop("checked",!0)})}}),t.prepare(),t.dialog.show()}get_fields(){var t=this,e=Object.keys(get_doc_mappings());return[{label:__("Reference"),fieldtype:"Select",fieldname:"interaction_type",options:e,reqd:1,onchange:function(){var e=t.get_values();t.get_fields().forEach(function(e){"interaction_type"!=e.fieldname&&(t.dialog.set_df_property(e.fieldname,"reqd",0),t.dialog.set_df_property(e.fieldname,"hidden",0))}),t.set_reqd_hidden_fields(e),t.get_event_categories()}},{label:__("Category"),fieldtype:"Select",fieldname:"category",options:"",hidden:1},{label:__("Public"),fieldtype:"Check",fieldname:"public",default:"1"},{fieldtype:"Column Break"},{label:__("Date"),fieldtype:"Datetime",fieldname:"due_date"},{label:__("Assigned To"),fieldtype:"Link",fieldname:"assigned_to",options:"User"},{fieldtype:"Section Break"},{label:__("Summary"),fieldtype:"Data",fieldname:"summary"},{fieldtype:"Section Break"},{fieldtype:"Text Editor",fieldname:"description"},{fieldtype:"Section Break"},{label:__("Select Attachments"),fieldtype:"HTML",fieldname:"select_attachments"}]}get_event_categories(){var t=this;frappe.model.with_doctype("Event",function(){var e=frappe.meta.get_docfield("Event","event_category").options.split("\n");t.dialog.get_input("category").empty().add_options(e)})}prepare(){this.setup_attach()}set_reqd_hidden_fields(t){var e=this;if(t&&"interaction_type"in t){var i=get_doc_mappings();i[t.interaction_type].reqd_fields.forEach(function(t){e.dialog.set_df_property(t,"reqd",1)}),i[t.interaction_type].hidden_fields.forEach(function(t){e.dialog.set_df_property(t,"hidden",1)})}}setup_attach(){var t=this,e=this.dialog.fields_dict,i=$(e.select_attachments.wrapper);this.attachments||(this.attachments=[]);var s={folder:"Home/Attachments",on_success:function(e){return t.attachments.push(e)}};this.frm&&(s={doctype:this.frm.doctype,docname:this.frm.docname,folder:"Home/Attachments",on_success:function(e){t.frm.attachments.attachment_uploaded(e),t.render_attach()}}),$("<h6 class='text-muted add-attachment' style='margin-top: 12px; cursor:pointer;'>"+__("Select Attachments")+"</h6><div class='attach-list'></div>\t\t\t<p class='add-more-attachments'>\t\t\t<a class='text-muted small'><i class='octicon octicon-plus' style='font-size: 12px'></i> "+__("Add Attachment")+"</a></p>").appendTo(i.empty()),i.find(".add-more-attachments a").on("click",function(){return new frappe.ui.FileUploader(s)}),this.render_attach()}render_attach(){var t=this.dialog.fields_dict,e=$(t.select_attachments.wrapper).find(".attach-list").empty(),i=[];this.attachments&&this.attachments.length&&(i=i.concat(this.attachments)),cur_frm&&(i=i.concat(cur_frm.get_files())),i.length&&$.each(i,function(t,i){i.file_name&&(i.file_url=frappe.urllib.get_full_url(i.file_url),$(repl('<p class="checkbox"><label><span><input type="checkbox" data-file-name="%(name)s"></input></span><span class="small">%(file_name)s</span> <a href="%(file_url)s" target="_blank" class="text-muted small"><i class="fa fa-share" style="vertical-align: middle; margin-left: 3px;"></i></label></p>',i)).appendTo(e))})}create_action(){var t=this.dialog.get_primary_btn(),e=this.get_values();if(e){var i=$.map($(this.dialog.wrapper).find("[data-file-name]:checked"),function(t){return $(t).attr("data-file-name")});this.create_interaction(t,e,i)}}get_values(){var t=this.dialog.get_values(!0);return t&&(t.reference_doctype=this.frm.doc.doctype,t.reference_document=this.frm.doc.name),t}create_interaction(t,e,i){var s=this;s.dialog.hide();var a=get_doc_mappings(),n={};return Object.keys(e).forEach(function(t){n[a[e.interaction_type].field_map[t]]=e[t]}),"event_type"in n&&(n.event_type=1==e.public?"Public":"Private"),"Event"==n.doctype&&(n.event_participants=[{reference_doctype:e.reference_doctype,reference_docname:e.reference_document}]),"owner"in n||(n.owner=frappe.session.user),frappe.call({method:"frappe.client.insert",args:{doc:n},btn:t,callback:function(t){t.exc?frappe.msgprint(__("There were errors while creating the document. Please try again.")):(frappe.show_alert({message:__("{0} created successfully",[e.interaction_type]),indicator:"green"}),"assigned_to"in e&&s.assign_document(t.message,e.assigned_to),i&&s.add_attachments(t.message,i),cur_frm&&(cur_frm.timeline.input&&cur_frm.timeline.input.val(""),cur_frm.reload_doc()))}})}assign_document(t,e){"ToDo"!=t.doctype&&frappe.call({method:"frappe.desk.form.assign_to.add",args:{doctype:t.doctype,name:t.name,assign_to:e,notify:1},callback:function(t){return t.exc?void frappe.show_alert({message:__("The document could not be correctly assigned"),indicator:"orange"}):void frappe.show_alert({message:__("The document has been assigned to {0}",[e]),indicator:"green"})}})}add_attachments(t,e){frappe.call({method:"frappe.utils.file_manager.add_attachments",args:{doctype:t.doctype,name:t.name,attachments:JSON.stringify(e)},callback:function(t){return t.exc?void frappe.show_alert({message:__("The attachments could not be correctly linked to the new document"),indicator:"orange"}):void 0}})}},frappe.templates.image_view_item_row='<div class="image-view-item has-checkbox ellipsis">  <div class="image-view-header doclist-row">   <div class="list-value">   {{ subject }}   </div>  </div>    <div class="image-view-body">   <a  data-name="{{ data.name }}"    title="{{ data.name }}"    href="#Form/{{ data.doctype }}/{{ data.name }}"   >    <div class="image-field"     data-name="{{ data.name }}"     style="     {% if (!data._image_url) { %}      background-color: {{ color }};     {% } %}     border: 0px;"    >     {% if (!data._image_url) { %}     <span class="placeholder-text">      {%= frappe.get_abbr(data._title) %}     </span>     {% } %}     {% if (data._image_url) { %}     <img data-name="{{ data.name }}" src="{{ data._image_url }}" alt="{{data.title}}">     {% } %}     <button class="btn btn-default zoom-view" data-name="{{data.name}}">      <i class="fa fa-search-plus"></i>     </button>    </div>   </a>  </div> </div> ',frappe.templates.photoswipe_dom='    <div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">     <div class="pswp__bg"></div>     <div class="pswp__scroll-wrap">       <div class="pswp__container">    <div class="pswp__item"></div>    <div class="pswp__item"></div>    <div class="pswp__item"></div>   </div>    <div class="pswp__more-items">    </div>       <div class="pswp__ui pswp__ui--hidden">     <div class="pswp__top-bar">            <div class="pswp__counter"></div>      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>      <button class="pswp__button pswp__button--share" title="Share"></button>      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>                <div class="pswp__preloader">      <div class="pswp__preloader__icn">        <div class="pswp__preloader__cut">       <div class="pswp__preloader__donut"></div>        </div>      </div>     </div>    </div>     <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">     <div class="pswp__share-tooltip"></div>    </div>     <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">    </button>     <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">    </button>     <div class="pswp__caption">     <div class="pswp__caption__center"></div>    </div>    </div>   </div>  </div>',frappe.templates.kanban_board='<div class="kanban">     <div class="kanban-column add-new-column">         <div class="kanban-column-title compose-column">             <a class="text-muted"> {{ __("Add a column") }}</a>         </div>         <form class="compose-column-form kanban-column-title">             <input class="new-column-title" name="title" type="text" autocomplete="off">         </form>     </div>     <div class="kanban-empty-state text-muted text-center" style="display: none;">         {{ __("Loading...") }}     </div> </div>',frappe.templates.kanban_column='<div class="kanban-column" data-column-value="{{title}}">  <div class="kanban-column-title indicator {{indicator}}">   <span>{{ __(title) }}</span>   <div class="btn-group column-options dropdown pull-right">     <a class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">       <button class="btn btn-default btn-xs"><span class="caret"></span></button>     </a>     <ul class="dropdown-menu" style="max-height: 300px; overflow-y: auto;">       <li><a data-action="archive">{{ __("Archive") }}</a></li>     </ul>   </div>  </div>  <div class="kanban-cards">   </div>   <div class="kanban-card add-card">   <div class="kanban-card-title">    <i class="octicon octicon-plus"></i> {{ __("Add " + doctype) }}   </div>  </div>  <div class="kanban-card new-card-area">   <textarea name="title"></textarea>  </div> </div>',frappe.templates.kanban_card='<div class="kanban-card-wrapper {{ disable_click }}" data-name="{{name}}">  <div class="kanban-card content">   <div class="kanban-card-title">    {{ title }}   </div>   <div class="kanban-card-meta">   </div>  </div> </div>'}();
//# sourceMappingURL=list.min.js.map
