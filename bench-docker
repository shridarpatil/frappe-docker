#!/bin/bash
# Frappe Docker CLI wrapper
# Usage: ./bench-docker up --dev --workers --socketio
#        ./bench-docker down
#        ./bench-docker logs
#        ./bench-docker shell
#        ./bench-docker bench migrate

set -e

COMMAND="${1:-help}"
shift || true

# Parse flags
DEV=""
WORKERS=""
SOCKETIO=""
PROD=""
DB="mariadb"

for arg in "$@"; do
    case $arg in
        --dev)      DEV=1 ;;
        --workers)  WORKERS=1 ;;
        --socketio) SOCKETIO=1 ;;
        --prod)     PROD=1 ;;
        --mariadb)  DB=mariadb ;;
        --postgres) DB=postgres ;;
        *)          EXTRA_ARGS="$EXTRA_ARGS $arg" ;;
    esac
done

case $COMMAND in
    up)
        make up dev=$DEV workers=$WORKERS socketio=$SOCKETIO prod=$PROD db=$DB
        ;;
    down)
        make down
        ;;
    restart)
        make restart workers=$WORKERS socketio=$SOCKETIO
        ;;
    logs)
        make logs
        ;;
    shell)
        make shell
        ;;
    bench)
        # Check if it's a get-app or new-app command - redirect to proper handler
        BENCH_CMD=$(echo "$EXTRA_ARGS" | awk '{print $1}')
        BENCH_ARGS=$(echo "$EXTRA_ARGS" | cut -d' ' -f2-)

        if [ "$BENCH_CMD" = "get-app" ]; then
            echo "Hint: Use './bench-docker get-app' instead for proper host sync"
            echo ""
            exec "$0" get-app $BENCH_ARGS
        elif [ "$BENCH_CMD" = "new-app" ]; then
            echo "Hint: Use './bench-docker new-app' instead for proper host sync"
            echo ""
            exec "$0" new-app $BENCH_ARGS
        else
            make bench CMD="$EXTRA_ARGS"
        fi
        ;;
    list-apps)
        make list-apps
        ;;
    new-app)
        APP_NAME=$(echo "$EXTRA_ARGS" | xargs)

        if [ -z "$APP_NAME" ]; then
            echo "Error: App name is required"
            echo "Usage: ./bench-docker new-app <app_name>"
            exit 1
        fi

        if [ -d "./apps/$APP_NAME" ]; then
            echo "Error: App '$APP_NAME' already exists in ./apps/"
            exit 1
        fi

        echo "Creating new app: $APP_NAME"

        # Create app inside container
        docker compose exec web-app bench new-app "$APP_NAME"

        # Copy app from container to host
        echo "Copying app to host ./apps/$APP_NAME..."
        docker compose cp web-app:/home/frappe/frappe-bench/apps/"$APP_NAME" ./apps/

        # Add to apps.txt if not already there
        if ! grep -q "^${APP_NAME}$" ./sites/apps.txt 2>/dev/null; then
            echo "$APP_NAME" >> ./sites/apps.txt
            echo "Added $APP_NAME to sites/apps.txt"
        fi

        # Regenerate override file
        make generate-override

        echo ""
        echo "App '$APP_NAME' created successfully!"
        echo "Restart to load the new app: ./bench-docker up --dev"
        echo "Then install on site: ./bench-docker bench --site site1.local install-app $APP_NAME"
        ;;
    get-app)
        APP_URL=$(echo "$EXTRA_ARGS" | awk '{print $1}' | xargs)
        BRANCH=$(echo "$EXTRA_ARGS" | awk '{print $2}' | xargs)

        if [ -z "$APP_URL" ]; then
            echo "Error: App URL is required"
            echo "Usage: ./bench-docker get-app <git-url> [branch]"
            exit 1
        fi

        # Extract app name from URL
        APP_NAME=$(basename "$APP_URL" .git)

        if [ -d "./apps/$APP_NAME" ]; then
            echo "Error: App '$APP_NAME' already exists in ./apps/"
            exit 1
        fi

        echo "Getting app: $APP_NAME from $APP_URL"

        # Get app inside container
        if [ -n "$BRANCH" ]; then
            docker compose exec web-app bench get-app --branch "$BRANCH" "$APP_URL"
        else
            docker compose exec web-app bench get-app "$APP_URL"
        fi

        # Copy app from container to host
        echo "Copying app to host ./apps/$APP_NAME..."
        docker compose cp web-app:/home/frappe/frappe-bench/apps/"$APP_NAME" ./apps/

        # Add to apps.txt if not already there
        if ! grep -q "^${APP_NAME}$" ./sites/apps.txt 2>/dev/null; then
            echo "$APP_NAME" >> ./sites/apps.txt
            echo "Added $APP_NAME to sites/apps.txt"
        fi

        # Regenerate override file
        make generate-override

        echo ""
        echo "App '$APP_NAME' installed successfully!"
        echo "Restart to load the new app: ./bench-docker up --dev"
        echo "Then install on site: ./bench-docker bench --site site1.local install-app $APP_NAME"
        ;;
    fix-db-permissions)
        # Fix DB permissions so workers can connect
        # Reads site_config.json and grants access from any host
        SITE="${EXTRA_ARGS:-site1.local}"
        SITE=$(echo "$SITE" | xargs)  # trim whitespace
        CONFIG_FILE="./sites/${SITE}/site_config.json"

        if [ ! -f "$CONFIG_FILE" ]; then
            echo "Error: Site config not found at $CONFIG_FILE"
            exit 1
        fi

        DB_TYPE=$(grep -o '"db_type": "[^"]*' "$CONFIG_FILE" | cut -d'"' -f4)
        DB_NAME=$(grep -o '"db_name": "[^"]*' "$CONFIG_FILE" | cut -d'"' -f4)
        DB_USER=$(grep -o '"db_user": "[^"]*' "$CONFIG_FILE" | cut -d'"' -f4)
        DB_PASS=$(grep -o '"db_password": "[^"]*' "$CONFIG_FILE" | cut -d'"' -f4)

        echo "Fixing DB permissions for site: $SITE"
        echo "  DB Type: ${DB_TYPE:-mariadb}, DB: $DB_NAME, User: $DB_USER"

        if [ "$DB_TYPE" = "postgres" ]; then
            docker compose exec -e PGPASSWORD=root postgres psql -h 127.0.0.1 -U postgres -c \
                "ALTER USER \"${DB_USER}\" WITH PASSWORD '${DB_PASS}'; GRANT ALL PRIVILEGES ON DATABASE \"${DB_NAME}\" TO \"${DB_USER}\";"
        else
            docker compose exec mariadb mariadb -h 127.0.0.1 -uroot -proot -e \
                "GRANT ALL PRIVILEGES ON \`${DB_NAME}\`.* TO '${DB_USER}'@'%' IDENTIFIED BY '${DB_PASS}'; FLUSH PRIVILEGES;"
        fi

        echo "Done! Workers should now be able to connect."
        ;;
    help|--help|-h)
        echo "Frappe Docker CLI"
        echo ""
        echo "Usage: ./bench-docker <command> [options]"
        echo ""
        echo "Commands:"
        echo "  up [options]     Start containers"
        echo "    --dev          Dev mode (foreground with logs)"
        echo "    --workers      Include workers + scheduler"
        echo "    --socketio     Include socketio"
        echo "    --prod         Production (all services)"
        echo "    --mariadb      Use MariaDB (default)"
        echo "    --postgres     Use PostgreSQL"
        echo ""
        echo "  down             Stop all containers"
        echo "  restart          Restart containers"
        echo "  logs             Follow web-app logs"
        echo "  shell            Open bash in web-app"
        echo "  bench <cmd>      Run bench command"
        echo "  new-app <name>   Create a new Frappe app"
        echo "  get-app <url> [branch]  Clone app from git repository"
        echo "  list-apps        Show apps"
        echo "  fix-db-permissions [site]  Fix DB access for workers"
        echo ""
        echo "Examples:"
        echo "  ./bench-docker up --dev"
        echo "  ./bench-docker up --dev --workers"
        echo "  ./bench-docker up --dev --postgres"
        echo "  ./bench-docker up --prod"
        echo "  ./bench-docker new-app my_custom_app"
        echo "  ./bench-docker get-app https://github.com/frappe/erpnext"
        echo "  ./bench-docker get-app https://github.com/frappe/erpnext version-15"
        echo "  ./bench-docker bench migrate"
        ;;
    *)
        echo "Unknown command: $COMMAND"
        echo "Run './bench-docker help' for usage"
        exit 1
        ;;
esac
